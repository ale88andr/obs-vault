
### Получение информации о базе данных

#### 1. Размер базы данных

Чтобы получить физический размер файлов (хранилища) базы данных, используем следующий запрос:

```sql
SELECT pg_database_size(current_database());
```

`current_database()` — функция, которая возвращает имя текущей базы данных.

Вместо функции можно ввести имя текстом.

```sql
SELECT pg_database_size('postgres');
```

Для того, чтобы получить информацию в человекочитаемом виде, можно использовать функцию `pg_size_pretty`:

```sql
SELECT pg_size_pretty(pg_database_size(current_database()));
```

#### 2. Перечень таблиц

Иногда требуется получить перечень таблиц базы данных. Для этого используем следующий запрос:

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema NOT IN ('information_schema','pg_catalog');
```

`information_schema` — стандартная схема базы данных, которая содержит коллекции представлений (`views`), таких как таблицы, поля и т.д. Представления таблиц содержат информацию обо всех таблицах баз данных.

#### 3. Размер таблицы

По аналогии с получением размера базы данных размер данных таблицы можно вычислить с помощью соответствующей функции:

```sql
SELECT pg_relation_size('accounts');
```

Функция `pg_relation_size` возвращает объём, который занимает на диске указанный слой заданной таблицы или индекса.

Для того, чтобы получить информацию в человекочитаемом виде, можно использовать функцию `pg_size_pretty`:

```sql
SELECT pg_size_pretty(pg_relation_size('accounts'));
```

#### 4. Имя самой большой таблицы

Для того, чтобы вывести список таблиц текущей базы данных, отсортированный по размеру таблицы, выполним следующий запрос:

```sql
SELECT relname, relpages FROM pg_class ORDER BY relpages DESC;
```

`relname` — имя таблицы, индекса, представления и т.п.
`relpages` — размер представления этой таблицы на диске в количествах страниц (по умолчанию одна страницы равна 8 Кб).
`pg_class` — системная таблица, которая содержит информацию о связях таблиц базы данных.

#### 5. Перечень подключенных пользователей

Чтобы узнать имя, IP и используемый порт подключенных пользователей, выполним следующий запрос:

```sql
SELECT datname,usename,client_addr,client_port FROM pg_stat_activity;
```

#### 6. Активность пользователя

Чтобы узнать активность соединения конкретного пользователя, используем следующий запрос:

```sql
SELECT datname FROM pg_stat_activity WHERE usename = 'posgtres';
```

### Работа с данными и полями таблиц

#### 1. Безопасное изменение типа поля
Для поля `id` используется строковый тип данных `varchar`. Это ошибка, так как в этом поле предполагается хранить идентификаторы покупателей, которые имеют целочисленный формат `integer`. Попробуем исправить это недоразумение с помощью команды `ALTER`:

```sql
ALTER TABLE hero ALTER COLUMN id TYPE integer;
```

Но в результате выполнения получим ошибку:

```
ERROR: column "id" cannot be cast automatically to type integer
```

Это значит, что нельзя просто так взять и изменить тип поля при наличии данных в таблице. Так как использовался тип varchar, СУБД не может определить принадлежность значения к `integer`. Хотя данные соответствуют именно этому типу. Для того, чтобы уточнить этот момент, в сообщении об ошибке предлагается использовать выражение `USING`, чтобы корректно преобразовать данные в `integer`:

```sql
ALTER TABLE hero ALTER COLUMN id TYPE integer USING(id::integer);
```

При использовании `USING` кроме конкретного выражения возможно использование функций, других полей и операторов. Например, можно преобразовать поле `id` обратно в `varchar`, но с преобразованием формата данных:

```sql
ALTER TABLE hero ALTER COLUMN id TYPE varchar USING (id || '-' || name);
```

#### 2. Подсчёт количества строк в таблице
Количество строк вычисляется стандартной функцией count, но её можно использовать с дополнительными условиями. Общее количество строк в таблице:

```sql
SELECT count(*) FROM hero;
```

Количество строк при условии, что указанное поле не содержит `NULL`:

```sql
SELECT count(col_name) FROM table;
```

Количество уникальных строк по указанному полю:

```sql
SELECT count(distinct name) FROM hero;
```

#### 3. Использование транзакций
Транзакция объединяет последовательность действий в одну операцию. Её особенность в том, что при ошибке в выполнении транзакции ни один из результатов действий не сохранится в базе данных.

- Начнём транзакцию с помощью команды `BEGIN`.
- Для того, чтобы откатить все операции, расположенные после `BEGIN`, используем команду `ROLLBACK`.
- А чтобы применить — команду `COMMIT`.

#### 4. Просмотр и завершение исполняемых запросов

Для того, чтобы получить информацию о запросах, можно выполнить следующую команду:

```sql
SELECT pid, age(query_start, clock_timestamp()), usename, query
FROM pg_stat_activity
WHERE query != '' AND query NOT ILIKE '%pg_stat_activity%'
ORDER BY query_start desc;
```

Для того, чтобы остановить конкретный запрос, выполним следующую команду, с указанием `id` процесса (`pid`):

```sql
SELECT pg_cancel_backend(procpid);
```

Для того, чтобы прекратить работу запроса, можно выполнить:

```sql
SELECT pg_terminate_backend(procpid);
```

### Работа с конфигурацией

#### 1. Поиск и изменение расположения экземпляра кластера

Возможна ситуация, когда на одной операционной системе настроено несколько экземпляров `PostgreSQL`, которые «сидят» на различных портах. В этом случае поиск пути к физическому размещению каждого экземпляра — достаточно нервная задача. Для того, чтобы получить эту информацию, выполним следующий запрос для любой базы данных интересующего кластера:

```sql
SHOW data_directory;
```

Изменить расположение на другое можно с помощью команды:

```sql
SET data_directory to new_directory_path;
```

Но для того, чтобы изменения вступили в силу, требуется перезагрузка.

#### 2. Получение перечня доступных типов данных

Получим перечень доступных типов данных с помощью команды:

```sql
SELECT typname, typlen from pg_type where typtype='b';
```

`typname` — имя типа данных.
`typlen` — размер типа данных.

#### 3. Изменение настроек СУБД без перезагрузки

Настройки `PostgreSQL` находятся в специальных файлах вроде postgresql.conf и `pg_hba.conf`. После изменения этих файлов нужно, чтобы СУБД снова получила настройки. Для этого производится перезагрузка сервера баз данных. Приходится это делать, но на продакшн-версии проекта, которым пользуются тысячи пользователей, это очень нежелательно. Поэтому в `PostgreSQL` есть функция, с помощью которой можно применить изменения без перезагрузки сервера:

```sql
SELECT pg_reload_conf();
```

Функция применима не ко всем параметрам. В некоторых случаях для применения настроек перезагрузка обязательна.