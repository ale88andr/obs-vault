
`PostgreSQL` управляет доступом при помощи так называемых ролей.

Роли похожи на обычные системные права доступа `Unix`, однако, в отличие от `Unix`, они не делятся на пользователей и группы.

Роли могут быть членами других ролей, что позволяет им наследовать параметры привилегий определенных ранее ролей.

### 1. Просмотр ролей

Чтобы просмотреть существующие роли PostgreSQL, нужно открыть командную строку СУБД:

```sql
sudo -i -u postgres psql
```

далее введем команду:

```sql
\du
```

После установки в `PostgreSQL` существует всего одна роль `postgres`, которая обладает широкими правами доступа.

![[Pasted image 20250820164136.png]]

### 2. Создание ролей PostgreSQL

Существует два базовых способа создания ролей: в командной строке `PostgreSQL` и в командной строке системы.

##### Создание роли в PostgreSQL

Проще всего создавать новые роли в командной строке PostgreSQL. Для этого используется следующий синтаксис:

```sql
CREATE ROLE new_role_name;
```

Для примера создадим новую роль (условно назовём её `demo`):

```sql
CREATE ROLE demo;
```

Проверяем список существующих ролей:

```sql
\du
```

![[Pasted image 20250820164743.png]]

В списке появилась новая роль. На данный момент у неё нет привилегий входа.

##### Создание роли в командной строке системы и в SQL

Также можно создать роль при помощи команды `createuser`. Закройте командную строку `PostgreSQL`:

```sql
\q
```

Чтобы создать роль в командной строке системы, введем следующую команду (условно назовём её `test`):

```shell
sudo su - postgres
createuser test
```

Снова откроем командную строку `Postgres` и запросим список существующих ролей:

```sql
exit
sudo -i -u postgres psql
\du
```

![[Pasted image 20250820170008.png]]

Роли, созданные разными методами, не идентичны. Роль, созданная в командной строке системы, имеет привилегии входа.

Зададим роль пользователя, пример команды из оболочки SQL:

```sql
CREATE USER user123 WITH PASSWORD 'myPassword';
```

### Удаление ролей PostgreSQL

Для удаления роли используется следующий синтаксис:

```sql
DROP ROLE demo_role;
```

Если заданной в команде роли не существует, команда вернет ошибку

Оператор `IF EXISTS` позволяет избежать этой ошибки; команда с таким оператором удалит роль, если она существует. Если указанной роли нет, команда не вернёт ошибку.

```sql
DROP ROLE IF EXISTS role_name;
```

### 3. Определение привилегий во время создания роли

Теперь попробуем снова создать роль `demo_role`, заранее установив её права доступа. Права роли можно указать сразу после главного оператора `create`.

Синтаксис выглядит так:

```sql
CREATE ROLE role_name WITH optional_permissions;
```

Полный список опций доступа можно просмотреть при помощи команды:

```sql
\h CREATE ROLE
```

Чтобы у пользователя, связанного с этой ролью, были привилегии входа, введите:

```sql
CREATE ROLE demo_role WITH LOGIN;
```

Проверим список существующих ролей и обратим внимание на то, что теперь обе роли имеют одинаковые привилегии:

```sql
\du
```

Чтобы роль имела права входа, используется `CREATE USER`

```sql
CREATE USER role_name;
```

Команда `CREATE USER` отличается только тем, что автоматически даёт роли привилегии входа.

### 4. Управление правами роли PostgreSQL

Чтобы изменить права доступа уже существующей роли, используется команда `ALTER ROLE`. Её базовый синтаксис:

```sql
ALTER ROLE role_name WITH attribute_options;
```

```sql
ALTER ROLE demo WITH NOLOGIN;
```

### 5. Смена пользователя PostgreSQL

По умолчанию пользователи могут входить только локально, если имя системного пользователя совпадает с именем роли `PostgreSQL`.

Чтобы изменить это поведение, можно изменить тип входа или настроить `PostgreSQL` для прослушивания локального интерфейса (это изменит тип подключения на удаленный).

По умолчанию `PostgreSQL` подразумевает, что для входа будет использоваться роль, одноименная системному пользователю, и что такая роль будет подключаться к одноименной базе данных.

Но в данном случае это не так, потому нужно явно указать опции. Для этого используется синтаксис:

```shell
psql -U user_name -d database_name -h 127.0.0.1 -W
```

Оператор `-h 127.0.0.1` указывает, что нужно подключиться к локальной машине по сетевому интерфейсу. Это позволит проходить аутентификацию, даже если имя пользователя и имя роли не совпадают. Флаг `–W` значит, что при входе в `PostgreSQL` нужно ввести пароль.

```shell
psql -U test_user -d postgres -h 127.0.0.1 -W
```

### 6. Управление привилегиями PostgreSQL

#### Передача привилегии

Как правило, при создании БД или таблицы права доступа к ней есть только у создавшей её роли. Но такое поведение можно изменить.

Передавать права доступа другим ролям можно при помощи команды `GRANT`. Базовый синтаксис:

```sql
GRANT permission_type ON table_name TO role_name;
```




