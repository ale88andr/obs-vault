**Задачи мониторинга БД:**

- Проверка наличия сообщений об ошибках в файлах журналов
- Проверка свободного пространства на диске и использования диска (это позволит предотвратить ситуацию, в которой базе данных не хватает места на диске)
- Мониторинг использования ресурсов сервера и ошибок (процессор, память, подкачка, операции ввода-вывода диска и операции ввода-выврда сети)
- Проверка состояния периодического резервного копирования
- Мониторинг использования откатов (время выполнения откатов и продолжительность выполнения)
- Конфигурирование оповещений при возникновении некоторых ситуаций (например, нарушение определенных ограничений, слишком продолжительное удерживание блокировки или возникновение тупиковой ситуации, слишком медленное выполнение запросов или избыточное использование ресурсов)

**Что мониторить в БД?**

- Доступность извне (доступна ли среда для пользователей)
- Подключение и их активность (подключения могут подвисать и занимать ресурсы)
- Работа с данными (индексы, размеры таблиц)
- Планы запросов
- Фоновые процессы (BackgroundWriter, контрольные точки)
- Системные параметры (cpu, network, disk, memory) 
- Блокировки и ожидания (Готовность Postgres принимать запросы)
- Обработка транзакций (COMMIT, ROLLBACK)
- Автовакуум (очистка таблиц)
- Фоновая запись изменений и чекпоинты

Все метрики можно брать из системных представлений Postgres

![[Pasted image 20231030113254.png]]

**Чем собирать логи?**

**Prometheus** — это бесплатный инструмент с открытым исходным кодом, используемый для мониторинга и оповещения о событиях. Он был разработан в 2012 году компанией SoundCloud и в 2016 году переведен в Фонд облачных вычислений.

Prometheus работает, собирая и сохраняя данные временных рядов. Собранные метрики сохраняются с парами ключ/значение и отметкой времени, когда они были собраны.

**Чем отображать собранные логи?**

**Grafana** — это кроссплатформенный инструмент, обеспечивающий визуализацию с богатым контекстом с помощью графиков и других методов представления данных. Он поддерживает показатели из нескольких источников данных, таких как ElasticSearch, InfluxDB, Amazon Timestream, Prometheus, PostgreSQL, MySQL, Graphite и т. д.

Одна из замечательных особенностей Grafana заключается в том, что пользователи могут настраивать каждую панель инструментов в соответствии с желаемыми потребностями проекта. Другая функция — это конструктор запросов Prometheus, который упрощает создание и выполнение запросов PromQL.

### Установка

**Prometheus**

Скачиваем дистрибутив:

```Shell
wget https://github.com/prometheus/prometheus/releases/download/v2.37.1/prometheus-2.37.1.linux-amd64.tar.gz
```

Распаковываем его:

```Shell
tar -xvf prometheus-2.37.1.linux-amd64.tar.gz
```

Копируем бинарный файл `prometheus` в `/usr/bin`

![[Pasted image 20231030132106.png]]

```Shell
sudo cp prometheus-2.37.1.linux-amd64/prometheus /usr/bin
```

Создаём необходимые директории для `prometheus`:

```Shell
mkdir /etc/prometheus 
mkdir /var/lib/prometheus
```

Копируем консольные утилиты `prometheus` из распакованного архива в `/etc/prometheus`:

```Shell
sudo cp -r ./prometheus-2.37.1.linux-amd64/consoles /etc/prometheus/
sudo cp -r ./prometheus-2.37.1.linux-amd64/console_libraries /etc/prometheus/
```

Создаем конфигурационный файл `prometheus`:

```Shell
sudo nano /etc/prometheus/prometheus.yml
```

со следующим содержимым:

```Prometheus
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    scrape_interval: 5s
    static_configs:
      - targets: ["localhost:9090"]
```

Создаем пользователей, необходимых для работы `prometheus`:

```Shell
sudo useradd --no-create-home --shell /bin/false prometheus
sudo useradd --no-create-home --shell /bin/false node_exporter
sudo chown prometheus:prometheus /etc/prometheus
sudo chown prometheus:prometheus /var/lib/prometheus
sudo chown prometheus:prometheus /usr/bin/prometheus
sudo chown -R prometheus:prometheus /etc/prometheus/consoles
sudo chown -R prometheus:prometheus /etc/prometheus/console_libraries
sudo chown -R prometheus:prometheus /etc/prometheus/prometheus.yml
```

Далее, настраиваем сервис для запуска `prometheus`:

```Shell
sudo systemctl edit --full --force prometheus.service
```

```Shell
[Unit]
Desc ription=Prometheus
Wants=network-online.target 
After=network-online.target 
[Service]
User=prometheus 
Group=prometheus 
Type=simple	:
ExecStart=/usr/bin/prometheus \
--config.file /etc/prometheus/prometheus.yml \
--storage.tsdb.path /var/lib/prometheus/ \
--web.console.templates=/etc/prometheus/consoles \
--web.console.libraries=/etc/prometheus/console_lib 
[Install]
WantedBy=multi-user.target
```

Сохраняем и перезагружаем демон `systemctl`

```Shell
sudo systemctl daemon-reload
```

Запускаем `prometheus`:

```Shell
sudo systemctl start prometheus
sudo systemctl status prometheus
```

`prometheus` доступен на порту `9090`

**Graphana**

Устанавливаем необходимые пакеты:

```Shell
sudo apt-get install -y apt-transport-https
```

Добавляем репозиторий `graphana`:

```Shell
sudo apt-get install -y software-properties-common wget
```

```Shell
sudo wget -q -O /usr/share/keyrings/grafana.key https://packages.grafana.com/gpg.key
```

```Shell
echo "deb [signed-by=/usr/share/keyrings/grafana.key] https://packages.arafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
```

```Shell
echo "deb [signed-by=/usr/share/keyrings/grafana.key] https://packages.arafana.com/oss/deb beta main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
```

Обновляем `apt-get`:

```Shell
sudo apt-get update
```

Устанавливаем `grafana`, установится только через `vpn`:

```Shell
sudo apt install grafana
```

или

```Shell
sudo snap install grafana
```




