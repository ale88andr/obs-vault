
Установим утилиту **reprepro**

```shell
sudo apt install reprepo
```

### Процедура создания и настройки репозитория заключается в:

1. Создании ключа для репозитория.

2. Создании структуры репозитория:  
- создание каталога, в котором будет размещен репозиторий  
- заполнение конфигурационного файла **distributions**- создание структуры репозитория, согласно конфигурационного файла **distributions**

3. Экспорта открытого ключа репозитория

4. Скачивания и добавления в репозиторий необходимых **deb-пакетов**

5. Организации распространения пакетов по протоколу ftp или http (опционально)

### Создание ключа для репозитория

Для создания ключа, необходимо выполнить команду **sudo gpg --gen-key**. Она в интерактивном режиме запросит информацию об вашем имени, электронной почте, и фразу-пароль (необходимо её запомнить, она понадобится для дальнейших шагов). При генерации ключей, она попросит вводить текст с клавиатуры, совершать движение мышью, печатать на клавиатуре или обращаться к дискам, для генерации случайных чисел и создания достаточного количества энтропии для повышения крипто стойкости ключа.

Команда для генерации ключа репозитория:

```shell
sudo gpg --gen-key
```

### Создание структуры репозитория

Создадим каталог для репозитория, например, `/srv/repository/local` и в нем каталог `conf`. После чего перейдем в него.

```shell
sudo mkdir -p /srv/repository/securepo/conf
cd /srv/repository/securepo/conf
```

Теперь необходимо создать конфигурационный файл `distributions`:

```shell
sudo nano distributions
```

со следующим содержимым:

```
Codename: localrepo  
Suite: stable  
Version: 1.0  
Origin: Debian  
Label: localrepo Debian Repository  
Description: localrepo Debian repository  
Architectures: source amd64  
Components: main  
SignWith: yes  
DebIndices: Packages Release . .gz .bz2  
DscIndices: Sources Release . .gz .bz2  
Contents: . .gz .bz2
```

Для инициализации нового репозитория выполнить команду:

```shell
sudo reprepro --ask-passphrase -b /srv/repository/securepo export
```

утилита попросит ввести парольную фразу закрытого ключа

1. Наполнить репозиторий пакетами:
    
    1. Добавление бинарного deb пакета:
        
        ``sudo reprepro -b <путь_к_репозиторию> includedeb <кодовое_имя_дистрибутива> <путь_к_пакету/имя_пакета>.deb``
        
    2. Добавление всех пакетов deb из каталога <путь_к_пакетам>:
        
        `sudo reprepro -b <путь_к_репозиторию> includedeb <кодовое_имя_дистрибутива> <путь_к_пакетам>/*.deb`
        
        При появлении ошибки: No priority given for '<имя_пакета>', skipping выполнить добавление пакета с игнорированием приоритета с помощью опции -P:
        
        `sudo reprepro -P -V -b <путь_к_репозиторию> includedeb <кодовое_имя_дистрибутива> <путь_к_пакету/имя_пакета>.deb`
        
    3. Добавление бинарного udeb пакета:
        
        `sudo reprepro -b <путь_к_репозиторию> includeudeb <кодовое_имя_дистрибутива> <путь_к_пакету/имя_пакета>.udeb`
        
    4. Добавление пакета с исходным текстом:
        
        `sudo reprepro -b <путь_к_репозиторию> includedsc <кодовое_имя_дистрибутива> <путь_к_пакету/имя_пакета>.dsc`
        
    5. Удаление пакета:
        
        `sudo reprepro -b <путь_к_репозиторию> remove <кодовое_имя_дистрибутива> <имя_пакета_без_версии>`


### Экспорт открытого ключа собственного локального репозитория

Для экспорта открытого ключа собственного репозитория, необходимо из каталога `/srv/repository/securepo` выполнить команду:

```shell
sudo gpg --armor --output repo_gpg.key --export
```

### Добавления в репозиторий deb-пакетов

Добавим нужные нам пакеты в репозитории. Для начала скачаем deb-пакет (например, `yandex-disk`) в предварительно созданную в домашнем каталоге папку `packages`:

```shell
mkdir ~/packages

cd ~/packages

wget http://repo.yandex.ru/yandex-disk/yandex-disk_latest_amd64.deb
```

Затем разместим скачанный пакет в репозитории командой:

```shell
sudo reprepro --ask-passphrase -b /srv/repo/localrepo/ -C main includedeb stable ~/packages/yandex-disk_latest_amd64.deb
```

После ввода фразы-пароля он будет размещен в репозитории

> При появлении ошибки: No priority given for '<имя_пакета>', skipping выполнить добавление пакета с игнорированием приоритета с помощью опции -P:

```shell
sudo reprepro -P -V -b <путь_к_репозиторию> includedeb <кодовое_имя_дистрибутива> <путь_к_пакету/имя_пакета>.deb
```

Для проверки, что наш репозиторий работает, пока, обратимся к нему локально. Добавим наш репозиторий в файл `/etc/apt/sources.list`, добавим открытый ключ репозитория в хранилище ключей для **apt**, обновим локальный кэш и попробуем установить пакет.

1. Добавим наш репозиторий в файл `/etc/apt/sources.list`

```shell
echo "deb file:///srv/repo/localrepo localrepo main" | sudo tee --append /etc/apt/sources.list
```

Проверим, что ссылка на локальный репозиторий добавилась в конец файла `/etc/apt/sources.list`

2. Добавим открытый ключ репозитория в хранилище ключей для **apt:**

```shell
sudo apt-key add /srv/repo/localrepo/repo_gpg.key
```

3. Обновим локальный кэш пакетов

```shell
sudo apt update
```

4. Произведем установку пакета `yandex-disk_latest_amd64.deb`

```shell
sudo apt install yandex-disk
```

![[Pasted image 20250218105004.png]]

Мы видим, что пакет устанавливается из локального репозитория.

## Распространение пакетов с помощью Apache2

Если нам нужно, чтобы производить установку с нашего локального репозитория могли и другие компьютеры в сети, то нужно развернуть **web-сервер Apache2**. Установить Apache2 со всеми зависимостями нужно из репозитория **main** (тот что сертифицируется) а остальные репозитории закоментировать, чтобы из них не были установлены пакеты других версий. Это может вызвать неработоспособность `Apache2`.

```shell
sudo nano /etc/apt/sources.list
```

После чего обновляем индекс пакетов командой:

```shell
sudo apt update
```

1. производим установку **apache2:**

```shell
sudo apt install apache2
```

2. После установки `apache2` нужно в его конфигурационном файле отключить режим `AstraMode`:

```shell
sudo nano /etc/apache2/apache2.conf
```

![[Pasted image 20250218105635.png]]

3. Затем необходимо перезапустить web-сервер и обязательно убедиться, что служба стартовала без ошибок:

```shell
sudo systemctl restart apache2.service
sudo systemctl status apache2.service
```

4. Если репозиторий расположен вне каталога `/var/www/html`, как у нас, а, например, в каталоге `/srv/repository`, то нужно cоздать символьную ссылку на репозиторий:

```shell
sudo ln -s /srv/repository/securepo /var/www/html/securepo
```

5. В `/etc/apache2/sites-enabled/000-default.conf` после строки `DocumentRoot /var/www/html` добавить:

```shell
sudo nano /etc/apache2/sites-enabled/000-default.conf
```

```
<Directory /var/www/html/repo>  
Options Indexes MultiViews FollowSymLinks  
AllowOverride None  
Order Deny,Allow  
Require all granted  
</Directory>
```

![[Pasted image 20250218110419.png]]

6. Затем необходимо перезапустить **web-сервер** и обязательно убедиться, что служба стартовала без ошибок:

```shell
sudo systemctl restart apache2.service
sudo systemctl status apache2.service
```

### Настройка клиентов репозитория

Дальнейшие действия нужно производить на хостах, с которых Вы хотите удаленно подключаться с репозиторию и устанавливать пакеты.

1. Сначала нужно добавить открытый ключ (`repo_gpg.key`) репозитория в хранилище ключей для **apt**. Ключ лежит на компьютере c репозиторием в папке `/srv/repository/securepo/`.
2. Перенесем ключ `*_gpg.key` с компьютера c репозиторием на компьютер в домашний каталог любым доступным способом
3. Теперь нужно добавить открытый ключ (`*_gpg.key`) репозитория в хранилище ключей для **apt** на компьютере:

```shell
sudo apt-key add ~/*_gpg.key
```

4. Добавим на компьютере в файл `/etc/apt/sources.list` последнюю строчку - `deb http://xxx.xxx.xxx.xxx/securepo/ securepo main`. Таким образом мы добавили ссылку на сетевой репозиторий.

![[Pasted image 20250218111756.png]]

5. Далее обновим индекс пакетов, командой:

```shell
sudo apt update
```

6. Теперь мы можем установить пакет из сетевого репозитория командой:

```shell
sudo apt install yandex-disk
```



