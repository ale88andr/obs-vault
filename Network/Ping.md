
### Для чего используется команда PING?

Команда ping один из базовых инструментов для работы с сетью. Наряду с проверкой доступности удаленного хоста, эта команда даёт возможность выполнять и другие диагностические задачи в том числе:

- измерение времени за которое общаются два хоста;
- выявление IP адреса конкретного хоста, как в локальной сети, так и в глобальной
- она может быть частью bash скрипта для автоматической проверки сетевого устройства
- проверка связи с конкретным устройством.

Как видно, эта команда очень необходима для администрирования сети и серверов.

---

### Как работает команда PING?

Принцип работы команды Ping прост: она посылает серию пакетов маленького размера на указанное устройство.

Для тестирования устройства может быть использован либо **IP-адрес**, либо **имя хоста**. После отправки пакета, утилита проверяет и измеряет время ответа целевого устройства.

Как вы могли предположить, время ответа зависит от нескольких условий в том числе географическое расположение или устройств, расположенных между источником и целевым устройством.

Например, в локальной проводной сети команда вернет лучший результат по времени, чем в сети с несколькими маршрутизаторами и сетевыми мостами.

Однако, на основе полученной информации утилита будет судить о состоянии целевого устройства.

Синтаксис команды следующий:

ping [options] [destination]

Ниже приведены некоторые полезные и часто используемые ключи для этой команды:

- `-c:` Позволяет указать количество пакетов для отправки.
- `-s:` Позволяет изменять размер пакета по умолчанию.
- `-v:` Отображает текущее состояние выполнения команды.
- `-w:` Указывает в секундах время завершения команды.
- `-i:` Позволяет указать интерфейс, с которого будут идти запросы.

---

### Можно ли использовать PING с прокси-сервером?

**Прокси** – это сервер или приложение играющее роль посредника для соединения двух хостов в сети. Это своего рода «человек посередине», который отправляет запросы прямо к хосту.

Проблема в том, что команда PING требует прямого соединения между устройствами. Таким образом, команда Ping не может функционировать если перед ним стоит прокси-сервер.

Как вариант, можно воспользоваться сайтами, которые предлагают команду Ping как услугу. С другой стороны, для решения некоторых задач с командой Ping, можно использовать команду `curl`. Также можно прибегнуть к помощи [VPN, который спрячет ваш реальный IP](https://wiki.merionet.ru/seti/27/chto-takoe-vpn-i-kak-on-obxodit-blokirovki/).

---

### Ping IPv6 адресов

По умолчанию, когда запускаем команду PING, мы используем IP версии 4. Однако, с появлением протокола IPv6, все чаще стали встречаться адреса такого формата.

Ядро Linux поддерживает **IPv6** начиная с версии 2.2, так что все дистрибутивы Linux поддерживают этот протокол.

Базовый синтаксис таков:

```
$ ping -6 2001:4860:4860::8888
```

В старых версиях была команда `ping6`. В новых дистрибутивах её нет и весь функционал объединен с `ping`.

Как и при работе с IPv4, ключом –c можем указать число пакетов, для отправки, а ключ `–i` – определяет интерфейс для исходящих запросов.

---

### Ping конкретного порта

Иногда приходится проверят доступен ли тот или иной порт на проверяемом хосте. К сожалению, команда Ping не имеет такой возможности, но это можно сделать с помощью `telnet`, который по умолчанию установлен на Linux.

Чтобы проверить доступность порта просто введите следующую команду:

```
telnet [host] [port]
```

```
telnet google.com 80
```

[![Пинг порта](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/2.png "Пинг порта")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/2.png)

---

### Ping с выводом времени

Хотя команда `ping` дает много полезной информации, но этого может быть недостаточно. Тем не менее, есть возможность настроить команду так, чтобы она показала дату и время отправки пакета. Это может сделать вывод приятней и полезней для скриптов и логирования.

Для этого достаточно прописать указанную ниже команду. Но вам придется установить пакет `ccze`.

```
ping [host] | xargs -n1 -i bash -c 'echo `date +%F %T`" {}"' | ccze
```

[![ccze](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/3.png "ccze")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/3.png)

Как видно из скриншота, команда показывает дату и время отправки каждого пакета.

---

### Ping всех устройств в указанной подсети

Командой Ping можно посылать сигнал всем хостам в сети или подсети. Для этого нужно запустить ping с ключом `–b` на широковещательный адрес, который заканчивается на 255. Например:

```
ping -b -c 4 192.168.1.255
```

[![-b](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/4.png "-b")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/4.png)

Итак, если хост назначения недоступен, значит либо там блокируются ICMP пакеты, либо есть проблемы с сетью или таблицей маршрутизации.

---

### Как завершить команду PING?

По умолчанию, в системе Linux команда Ping непрерывно посылает пакета на хост. Но если нужная информация получена, то необходимо как-то прервать выполнение команды. Для этого просто нужно нажать комбинацию клавиш `CTRL+C`.

[![Завершить пинг](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/5.png "Завершить пинг")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/5.png)

После этого команда немедленно остановится.

---

### Завершение работы команды по счетчику

Вы можете ограничить число посылаемых пакетов. Например, если поставить число пакетов равным 10, то после отправки указанного числа пакетов выполнение команды прекратится.

```
ping -c 10 [host]
```

[![Завершение по счетчику](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/6.png "Завершение по счетчику")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/6.png)

---

### Где расположена утилита PING?

В Unix-подобных системах таких, как Linux бинарные файлы обычно располагаются по пути

```
/usr/bin/
```

В этой папке можно найти все множество бинарных файлов, которые мы используем как команды в терминале. В других ОС семейства Linux, они могут быть расположены в:

```
/usr/sbin/
```

Проверить это можем командой `ls`:

```
$ ls /usr/bin | grep ping
```

[![grep ping](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/7.png "grep ping")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/7.png)

На скриншоте видно, что команда ping находится в папке

```
/usr/bin/
```

Другой метод, которым можно найти место расположения команд это `which`:

```
$ which ping
```

На выводе она даст следующую информацию:

```
/usr/bin/ping
```

---

### Проверка задержки командой PING

Одна из возможностей, предоставляемых командой PING, является возможность измерения времени отклика сети. По-другому это называется задержка или время ожидания.

Чтобы измерить задержку введи указанную команду и обратите внимание на ввыод:

```
ping -c 4 [host]
```

```
ping -c 4 192.168.1.1
```

[![Проверка задержки](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/8.png "Проверка задержки")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/8.png)

Как вы могли заметить, каждый пакет был отправлен с конкретным временем ответа. В конце же есть строка, которая начинается на:

```
rtt min/avg/max/mdev
```

Второе значение после знака равенства – это время задержки. В нашем случае он равен 6,798.

[![Задержка](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/9.png "Задержка")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/9.png)

С помощью этого показателя мы можем определить хосты, связь с которыми хуже и приять соответствующие меры.

---

### Поиск идеального значения MTU

**MTU (Maximum Transmission Unit)** это максимальный размер пакета, который может быть передан по сети.

Сегодня, в целях безопасности, в сетях создаются препятствия для работы MTU. Но большинство локальных сетей на основе Ethernet использует MTU размером **1500 байт**.

Если нужно найти самый подходящий размер MTU с помощью команды Ping, следует определить начальное значение и уменьшать его до тех пор, пока прекратятся ошибки. Если значение большое, мы получим следующую ошибку:

```
ping: local error: Message too long
```

Чтобы сделать это запустите следующую команду:

```
ping -M do -s [initial_value] [host]
```

[![MTU](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/10.png "MTU")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/10.png)

В нашем случае, значение размера пакета слишком большое. Поэтому уменьшаем его до 1472 байтов.

[![1472](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/11.png "1472")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/11.png)

Если получите другое сообщение, начальное значение должно быть уменьшено по единице до тех пор, пока не получите требуемый результат.

Если значение MTU известно, оно может быть использовано для улучшения сети. Особенное если сеть большая вплоть до городских сетей.

---

### Ping на 2-ом уровне OSI (использование arping)

С помощью команды ping диагностика проводится на основе IP-адреса конкретного узла в сети. Это связано с тем, что команда ping работает на [третьем сетевом уровне модели OSI](https://wiki.merionet.ru/seti/18/model-osi-eto-prosto/).

С другой стороны, можно использовать другую встроенную в Linux команду – `arping`. Эта утилита работает так же, как ping, но на втором – канальном уровне модели OSI.

Синтаксис команды следующий:

```
$ sudo arping [Ip_address]
```

```
$ sudo arping 192.168.1.1
```

В результате получите что-то подобное:

[![arping](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/12.png "arping")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/12.png)

Вывод команды показывает размер отправленного пакета, затем **MAC адрес** узла назначения, а также время ответа.

Отметим, что эта команда не предустановлена на системе **Debian** и производных.

---

### Ping по имени узла

По умолчанию, команда ping посылает пакеты на узел назначения используя IP адрес или имя узла назначения. Также нужно отметить, что большинство реализаций утилиты ping на Linux не разрешают **DNS** в обратном направлении.

Например, если мы запустим команду ping, указав IP адрес, он вернёт только IP узла. И наоборот, если параметром передадим имя узла, то команда вернет его IP адрес. Посмотрите вывод введя команду ниже:

```
$ ping google.com
```

---

### Ping маршрута (traceroute)

Сама по себе команда ping не показывает пути от источника к узлу назначения. Но это было бы очень кстати в том случае, когда узел назначения не отвечает, чтобы определить где именно теряется связь.

Команда `tracert` (Windows) или `traceroute` работают аналогично ping. Преимуществом этой команды является то, что он показывает весь путь следования пакета от источника до узла назначения.

В принципе traceroute посылает тот же ICMP пакет, что и Ping. Но в случае traceroute, в отличии от ping начально значение TTL пакета выставляется равным единице. Пакет доходит до первого узла по пути к узлу назначения. Устройство уменьшает TTL на одну единицу и если получается нуль, то возвращает сообщение об ошибке истечения времени пакета. В сообщение так же содержится IP адрес и имя хоста. Отправитель получает данное сообщение. Если оно не от узла назначения, то посылает второй пакет с TTL на один больше предыдущего. И так до тех пор, пока не получит ответ от узла назначения. Для получения пути нужно ввести команду:

```
traceroute [hostname/IPaddres]
```

[![traceroute](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/13.png "traceroute")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/13.png)

---

### Запустить команду если ping вернул ошибку

Представьте, что вам нужно получить оповещение если узел назначения перестал отвечать на запросы команды ping. Для этого нужно включить команду ping в **bash** скрипт и прописать нужные команды. Например, скрипт ниже позволяет вам проверить отвечает ли узел на запросы ping:

```
#! /bin/bash

ping -c 1 [host]

If [ $? -eq 0]; then

    #Your_command_here

Fi
```

---

### Установление размера пакета ping

По умолчанию, размер пакетов ICMP равен **56 байтам**. Это позволяет не влиять на работу сети во время проверки. Но при необходимости можно изменять это значение. Для этого достаточно запустить команду ping с ключом `–s` и требуемым размером. Например:

```
ping -s [packet_size] hostname/IP
```

Если нужно установить значение пакета равным 100 байтам, нужно прописать команду ниже:

```
ping -s 100 192.168.1.1
```

[![-s](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/14.png "-s")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/14.png)

---

### Отключение команды ping

Если вы обслуживаете сеть, то вам может быть необходимо отключить ответ на ping запросы в любое время. Это можно сделать как временно, так и постоянно, в зависимости от ваших нужд. Для временного отключения команды ping нужно ввести команду ниже от имени [root-а](https://wiki.merionet.ru/servernye-resheniya/37/kak-dat-polzovatelyu-sudo-prava-v-centos-8/):

```
$ su
$ echo "1" > /proc/sys/net/ipv4/icmp_echo_ignore_all
```

[![Отключение пинга](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/15.png "Отключение пинга")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/15.png)

Она выключить возможно ответа на ICMP запросы до перезагрузки системы. Но если нужно навсегда отключить эту возможность, то придется отредактировать файл

```
/etc/sysctl.conf
```

и добавить следующую строку:

```
$ nano /etc/sysctl.conf
```

```
net.ipv4.icmp_echo_ignore_all=1
```

[![sysctl.conf](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/16.png "sysctl.conf")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/16.png)

Сохраните файл и, для применения изменений введите команду:

```
$ sysctl -p
```

[![sysctl -p](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/17.png "sysctl -p")](https://wiki.merionet.ru/images/15-primerov-komandy-ping-dlya-diagnostiki-seti/17.png)

---

### Заключение

В этом материале мы рассмотрели, как команда ping работает в системе Linux. Ping одна из самых легких команд. Она позволяет лицам, ответственным в обеспечении нормально работы сети, выявлять проблемы и устранять их.