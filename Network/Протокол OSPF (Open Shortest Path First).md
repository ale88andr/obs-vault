Маршрутизация, бывает двух типов:
- статическая (маршруты прописываются вручную)
- динамическая (маршруты заполняются автоматически)

Протоколы динамической маршрутизации позволяют поддерживать таблицу маршрутизации в актуальном состоянии и автоматически обновлять её при изменениях(маршрутизаторы сами будут обмениваться информацией между собой)

Существует несколько различных протоколов динамической маршрутизации. Одним из самых популярных является `OSPF` (Open Shortest Path First). 

`OSPF` - это протокол динамической маршрутизации отслеживающий состояние канала(Link-State), использующий для нахождения кратчайшего пути алгоритм Дейкстры.

![[Pasted image 20240118124509.png]]

`OSPF` - это протокол внутридоменной маршрутизации (`interior gateway protocol` - IGP) и используется для маршрутизации в пределах ограниченной(локальной) сети. 

Аналогичные протоколы: `RIP`, `EIGRP`, `IS-IS`.

А между такими сетями - используются протоколы междоменной маршрутизации, такой как `BGP`

**Как работает `OSPF`**

`OSPF` маршрутизаторы должны распознать друг друга прежде чем начать обмениваться данными, для этого такие маршрутизаторы устанавливают соседские отношения, которые создаются специальными 'hello' сообщениями, которые маршрутизатор шлёт на все включенные порты и ждёт ответа, если ответ не получен, то сосед считается "мёртвым" и маршрутизатор перестает передавать на него трафик. После того как все соседние маршрутизатор подружились - они начинают обмен сообщениями `LSA`(Link-State Advertisement), которые содержат следующую информацию:
- информация о соседнем маршрутизаторе
- состояние каждого напрямую подключенного канала
- специальную метрику `cost`(стоимость) - значение, присваиваемое каналу на основании его пропускной способности 
полученные сведения маршрутизатор хранит в специальной базе топологии `LSDB` (Link-State Database), затем маршрутизаторы выполняют алгоритм Дейкстры SPF (выбор наилучшего пути), который расчитывает оптимальный маршрут к каждой сети и строит дерево SPF, после чего таблице маршрутизации предлагаются наилучшие пути к каждой сети(OSPF выбирает кратчайшие пути)

![[Pasted image 20240118131243.png]]

При этом протокол продолжает работать и отслеживать изменения в сети, а так же обмениваться сообщениями hello с соседями чтобы отслеживать их состояние

Во внутренней сети обычно маршрутизаторам выделяются две роли:
- Выделенный маршрутизатор (DR-designater router)
- Запасной выделенный маршрутизатор (BDR-bbackup designater router)

Назначение ролей происходит автоматически, но, при необходимости можно назначить их вручную.

В первую очередь обычный маршрутизатор пытается подружиться с DR маршрутизатором и отправляет ему информацию об изменениях в сети, а тот в свою очередь рассылает всем остальным.

# Обзор протокола Open Shortest Path First

### Маршаллинг данных в OSPF

Как и многие другие протоколы, разработанные на заре проектирования сетей, OSPF был разработан для минимизации вычислительной мощности, памяти и полосы пропускания, необходимых для передачи информации о маршрутизации IPv4 по сети. Два конкретных выбора, сделанных на ранних этапах процесса проектирования OSPF, отражают эту озабоченность по поводу использования ресурсов:

- OSPF использует поля фиксированной длины для упорядочивания данных, а не TLV. Это экономит накладные расходы на перенос дополнительных метаданных в виде заголовков Type Length Value (TLV), снижает требования к обработке, позволяя сопоставлять структуры данных фиксированного размера в памяти с пакетами по мере их приема с канала связи, и уменьшает размер данных OSPF на линии.
- OSPF разбивает базу данных топологии на несколько типов данных, а не полагается на один LSP с TLV. Это означает, что каждый вид информации - доступность, топология и т. д. - передается в уникальном формате пакета.

Каждый тип информации, которую OSPF может нести, переносится в разном типе **Link State Advertisement** (LSA). Вот некоторые из наиболее примечательных типов LSA:

- Тип 1: код 0x2001, Router LSA
- Тип 2: код 0x2002, Network LSA
- Тип 3: код 0x2003, Inter-Area Prefix LSA
- Тип 4: код 0x2004, Inter-Area Router LSA
- Тип 5: код 0x4005, AS-external LSA
- Тип 7: код 0x2007, Type-7 (NSSA) LSA

Существует ряд других типов LSA, включая непрозрачные данные, членство в группе многоадресной рассылки и LSA с лавинной рассылкой (например, для одного соседа, одного канала или одного домена лавинной рассылки).

Каждый маршрутизатор OSPF генерирует ровно один Router LSA (тип 1). Этот LSA описывает любых соседей, примыкающих к объявляемому маршрутизатору, а также любые подключенные достижимые пункты назначения. Состояние каналов связи на этих соседей и пунктов назначения определяется из объявления соседей и пункта назначения. Несмотря на фразу «состояние канала», каналы не объявляются как отдельная «вещь» (это часто вызывает путаницу). Если Router LSA становится слишком большим, чтобы поместиться в один IP-пакет (из-за MTU канала), он будет разделен на несколько IP-фрагментов для передачи от маршрутизатора к маршрутизатору. Каждый маршрутизатор повторно собирает весь Router LSA перед его локальной обработкой и лавинно рассылает весь Router LSA, если он изменяется.

OSPF также использует несколько разных типов пакетов - они не совпадают с типами LSA. Скорее, их можно рассматривать как разные «службы» в OSPF или, возможно, как разные «номера портов», выполняемые поверх протокола User Datagram Protocol (UDP) или протокола Transmission Control Protocol (TCP).

- Hello - это тип 1. Они используются для обнаружения и сохранения соседей.
- Database Descriptor (DBD) относится к типу 2. Они используются для описания таблицы локальной топологии.
- Link State Request (LSR) относится к типу 3. Они используются для запроса определенных объявлений состояния канала от соседнего маршрутизатора.
- Link State Update (LSU) относится к типу 4. Они используются для передачи объявлений состояния канала.
- Link State Acknowledgment - это тип 5. Это просто список заголовков LSA. Любой LSA, указанный в этом пакете, подтверждается как полученный передающим маршрутизатором.

---

### Обнаружение соседей и топологии

В качестве протокола состояния канала OSPF должен гарантировать, что каждый маршрутизатор в пределах области (flooding domain) имеет одну и ту же базу данных для расчета loop-free путей. Любое изменение в базе данных общей топологии может привести к возникновению зацикливания маршрутизации, который будет длиться до тех пор, пока существует изменение в базе данных общей топологии. Таким образом, одной из целей формирования соседей OSPF является обеспечение надежной flooding рассылки информации о топологии через сеть. Вторая причина формирования соседей OSPF - обнаружение топологии сети путем определения того, какие маршрутизаторы находятся рядом с локальным маршрутизатором. На рисунке 1 показан процесс формирования соседей OSPF.

![[Pasted image 20240122120830.png]]
На рисунке 1:

1. B отправляет пакет приветствия к A.
2. Поскольку приветствие B содержит пустой список видимых соседей, A переводит B в состояние инициализации и добавляет B в список видимых соседей.
3. A передает приветствие B в списке видимых соседей.
4. B получает приветствие от A и отправляет приветствие с A в списке видимых соседей.
5. A получает это приветствие. Поскольку сам A находится в списке соседей, A помещает B в двустороннее состояние. Это означает, что A проверил наличие двусторонней связи между собой и B.
6. Если по этой линии избираются DR и BDR, то выборы происходят после шага 5. Как только выборы завершены, DR и BDR переводятся в состояние exstart. Во время этого состояния ведущий и ведомый выбираются для обмена DBDS и LSA. По сути, мастер управляет потоком DBDS и LSA между новыми соседними маршрутизаторами. Соседние маршрутизаторы на канале point-to-point технически переходят непосредственно в состояние full state в этой точке.
7. B переведен в состояние обмена.
8. A отправляет B набор DBD с описанием своей базы данных. B отправляет набор DBD с описанием своей базы данных в A.
9. A отправляет запрос состояния канала B для каждого LSA, описанного B, и A не имеет его копии в своей локальной таблице топологии.
10. B отправляет LSA для каждого запроса Link State (LS) от A.
11. 11. Как только базы данных синхронизируются, B переводится в full state.

Процесс формирования соседей OSPF проверяет MTU на обоих концах линии связи, передавая MTU исходящего интерфейса в hello сообщении. Если два hello-пакета не совпадают по размеру MTU, два маршрутизатора OSPF не образуют смежности.

---

### Надежная лавинная рассылка.

OSPF должен не только гарантировать завершение первоначального обмена информацией о топологии, но также гарантировать, что текущие изменения в топологии сети будут переданы на каждый маршрутизатор во flooding domain. На рисунке 2 показан заголовок LSA OSPF. Изучение этого заголовка поможет нам понять, как OSPF надежно массово рассылает информацию о топологии и доступности через сеть.

![[Pasted image 20240122120846.png]]

На рисунке 2:

- LS Age - это (примерно) количество секунд с момента создания Link State Advertisement. Это число идет увеличивается, а не уменьшается. Когда LS Age достигает значения MAXAGE (на любом маршрутизаторе, а не только на исходном маршрутизаторе), маршрутизатор увеличивает порядковый номер на 1, устанавливает для LS Age максимальное число и повторно загружает LSA по всей сети. Это позволяет удалить старую информацию о топологии и доступности, которая не обновлялась некоторое время. Маршрутизатор, который инициирует какой-либо конкретный LSA, обновит свои LSA за некоторое количество секунд до того, как это поле LSA Age достигнет максимума- это интервал обновления LS.
- Link State Identifier - это уникальный идентификатор, присвоенный исходным маршрутизатором для описания этого LSA. Обычно это адрес канала или какой-либо адрес локального уровня канала (например, Ethernet Media Access Control (MAC-адрес).
- Advertising Router - это идентификатор маршрутизатора-отправителя. Его часто путают с IP-адресом, поскольку он часто является производным от локально настроенного IP-адреса, но это не IP-адрес.
- Link State Sequence Number указывает версию LSA. Как правило, более высокие числа означают более новые версии, хотя существуют более ранние версии OSPF, в которых используется круговое числовое пространство, а не абсолютно увеличивающееся. Реализации, которые используют абсолютно увеличивающееся числовое пространство, перезапускают процесс OSPF, если достигнут конец числового пространства.
- Link State Checksum - это контрольная сумма, вычисляемая для LSA, используемая для обнаружения ошибок при передаче или хранении информации.

Рисунок 3 используется для изучения процесса flooding рассылки.

На рисунке 3:

1. Линия связи на 2001: db8: 3e8: 100 :: / 64 настроена, запущена, подключена и т. д.
2. A перестраивает свой Router LSA (тип 1), чтобы включить эту новую информацию о доступности, упаковывает его в LSU (который может быть фрагментирован при размещении в IP-пакеты) и лавинно рассылает его B.
3. B получает это LSA и подтверждает его получение подтверждением состояния канала (link state acknowledgment). A повторно отправит LSA, если B не подтвердит его достаточно быстро.
4. Теперь B проверит свою таблицу топологии, чтобы определить, является ли этот LSA новым или копией уже имеющегося. B определяет это в первую очередь путем изучения порядкового номера, включенного в сам LSA. Если это новый (или обновленный) LSA, B инициирует тот же процесс для лавинной рассылки измененного LSA в C.

---

### Подведение итогов об OSPF

OSPF можно описать как:

- Изучение доступных пунктов назначения через конфигурацию и локальную информацию (проактивный протокол)
- Использование лавинной рассылки для синхронизации базы данных в каждой промежуточной системе в домене лавинной рассылки (протокол состояния канала)
- Расчет путей без петель с использованием алгоритма SPF Дейкстры
- Проверка двусторонней связи при формировании соседей путем переноса списка «видимых соседей» в своих пакетах приветствия.
- Проверка MTU при формировании смежности путем переноса MTU в приветственном пакете

OSPF широко используется в малых и крупных сетях, включая розничную торговлю, поставщиков услуг, финансовые и многие другие предприятия.

---

### Общие элементы OSPF и IS-IS

В предыдущих лекциях были рассмотрены аспекты, отличающие OSPF и IS-IS друг от друга. Однако есть ряд вещей, которые OSPF и IS-IS реализовали достаточно схожими способами, чтобы рассматривать их решения как простые варианты. К ним относятся обработка каналов с множественным доступом, концепция Shortest Path Tree и способ way two-way.

---

### Каналы с множественным доступом

Каналы с множественным доступом, такие как Ethernet, - это каналы, по которым подключенные устройства «совместно используют» доступную полосу пропускания, и каждое устройство может отправлять пакеты напрямую любому другому устройству, подключенному к тому же каналу. Каналы с множественным доступом создают особые проблемы для протоколов, которые синхронизируют базу данных по каналу.

Рассмотрим рисунок 3 для понимания.

![[Pasted image 20240122120916.png]]

Один из вариантов, который протокол может использовать при работе по каналу с множественным доступом, - это просто сформировать смежности, как это обычно происходит по каналу «точка-точка» (point-to-point). Например, на рисунке 3:

- A может образовывать смежность с B, C и D.
- B может образовывать смежность с A, C и D.
- C может образовывать смежность с A, B и D.
- D может образовывать смежность с A, B и C

Если используется этот шаблон формирования смежности, когда A получает новый фрагмент LSP (IS-IS) или LSA (OSPF) от некоторого маршрутизатора, не подключенного к совместно используемому каналу:

- A передаст новый фрагмент или LSA по отдельности B, C и D.
- Когда B получает фрагмент или LSA, он передаст новый фрагмент или LSA в C и D отдельно.
- Когда C получает фрагмент или LSA, он передает новый фрагмент или LSA D.

Учитывая передачу каждого фрагмента или LSA, а также следующий CSNP или подтверждение, чтобы гарантировать синхронизацию локальной базы данных на каждом маршрутизаторе, большое количество пакетов должно пересекать совместно используемый канал, чтобы гарантировать синхронизацию базы данных каждого устройства. Чтобы уменьшить переполнение каналов множественного доступа, IS-IS и OSPF выбирают одно устройство, которое отвечает за обеспечение того, чтобы каждое устройство, подключенное к каналу, имело синхронизированную базу данных. На рисунке 3 для IS-IS:

- Одно устройство выбрано для управления лавинной рассылкой по каналу. В IS-IS это устройство называется выделенной промежуточной системой (Designated Intermediate System - DIS).
- Каждое устройство с новой информацией о состоянии канала отправляет фрагмент на адрес многоадресной рассылки, чтобы каждое устройство в общем канале получило его. Ни одно из устройств, подключенных к каналу, не отправляет никаких подтверждений при получении обновленного фрагмента.
- DIS регулярно отправляет копию своего CSNP на один и тот же адрес многоадресной рассылки, поэтому каждое устройство в канале множественного доступа получает его копию.
- Если какое-либо устройство на общем канале обнаружит, что в нем отсутствует какой-то конкретный фрагмент, на основе описания базы данных DIS в CSNP, оно отправит PSNP в канал, запрашивая недостающую информацию.
- Если какое-либо устройство в общем канале обнаружит, что у него есть информация, которой нет у DIS, на основе описания базы данных DIS в CSNP, оно перенаправит недостающий фрагмент в канал.

Таким образом, новая информация о состоянии канала передается по линии минимальное количество раз. На рисунке 3 для OSPF:

- Для управления лавинной рассылкой по каналу выбирается одно устройство, называемое назначенным маршрутизатором (Designated Router - DR). Также выбирается резервное устройство, называемое резервным назначенным маршрутизатором (Backup Designated Router - BDR).
- Каждое устройство с новой информацией о состоянии канала пересылает ее на специальный адрес многоадресной рассылки, контролируемый DR и BDR (маршрутизаторами, работающими только как DR).
- DR получает этот LSA, проверяет его, чтобы определить, содержит ли он новую информацию, а затем повторно загружает его на многоадресный адрес, который прослушивают все маршрутизаторы OSPF на канале (все маршрутизаторы SPF).

Однако выбор DIS или DR не влияет только на лавинную передачу информации по каналу множественного доступа. Это также влияет на способ вычисления SPF через канал. Рисунок 4 показывает это.

![[Pasted image 20240122120935.png]]
На рисунке 4 A выбран в качестве DIS или DR для схемы множественного доступа. A не только гарантирует, что каждое устройство в канале имеет синхронизированную базу данных, но также создает псевдоузел или p-узел и объявляет его, как если бы это было реальное устройство, подключенное к сети. Каждый из маршрутизаторов, подключенных к совместно используемому каналу, объявляет о возможности подключения к p-узлу, а не к каждой из других подключенных систем.

В IS-IS A создает LSP для p-узла. Этот p-узел объявляет канал с нулевой стоимостью обратно каждому устройству, подключенному к каналу множественного доступа. В OSPF A создает Network LSA (тип 2).

Без этого p-узла сеть выглядит как full mesh (полная сетка) для других промежуточных систем в домене лавинной рассылки, как показано в левой части рисунка 4. С p-узлом сеть выглядит как hub-and-spoke с p-узлом в качестве концентратора. Каждое устройство объявляет канал на p-узел, при этом стоимость канала устанавливается равной стоимости локального интерфейса для совместно используемого канала. В свою очередь p-узел возвращает канал с нулевой стоимостью обратно на каждое устройство, подключенное к общему каналу. Это снижает сложность вычисления SPF для крупномасштабных каналов с множественным доступом.

Концептуализация связей, узлов и достижимости в протоколах состояний каналов

Один сбивающий с толку аспект протоколов состояния каналов - это то, как узлы, каналы и достижимость взаимодействуют друг с другом. Рассмотрим рисунок 5.
![[Pasted image 20240122120954.png]]

И в OSPF, и в IS-IS узлы и каналы используются как Shortest Path Tree, как показано более темными сплошными линиями. Пунктирные линии показывают, как информация о доступности прикрепляется к каждому узлу. Каждый узел, подключенный к конкретному достижимому пункту назначения, объявляет пункт назначения - не только один из двух узлов, подключенных к каналу точка-точка, но и оба. Почему так?

Основная причина в том, что это просто самое простое решение для объявления доступных мест назначения. Если вы хотите создать протокол маршрутизации, который объявлял бы каждое достижимое назначение только как подключенное к одному устройству, вам нужно было бы найти способ выбрать, какое из подключенных устройств должно объявлять достижимое назначение. Кроме того, если выбранное устройство выйдет из строя, то какое-то другое устройство должно взять на себя объявление достижимого пункта назначения, что может занять время и негативно повлиять на конвергенцию. Наконец, позволяя каждому устройству объявлять о доступности для всех подключенных пунктов назначения, вы фактически можете найти кратчайший путь к каждому пункту назначения.

---

### Проверка двустороннего подключения в SPF

Двусторонняя связь является проблемой для плоскостей управления в двух разных местах: между соседними устройствами и при вычислении путей без петель через сеть. И IS-IS, и OSPF также обеспечивают двустороннюю связь при вычислении путей без петель.

Существенным элементом является проверка обратной связи.

Рисунок 6 используется для демонстрации этого.

![[Pasted image 20240122121017.png]]

На рисунке 6 направление каждого звена обозначено стрелкой (или набором стрелок). Связь [A,B] является однонаправленной по отношению к A. Остальные связи являются двусторонними (двунаправленными). При вычислении SPF D будет делать следующее:

- При обработке информации о состоянии связи C обратите внимание, что C утверждает, что он подключен к B. D найдет информацию о состоянии связи B и проверит, чтобы убедиться, что B также утверждает, что он подключен к C. В этом случае B действительно утверждает, что подключен к C, поэтому D будет использовать канал [B, C].
- При обработке информации о состоянии связи B обратите внимание, что B утверждает, что он подключен к A. Однако, изучая информацию о состоянии связи A, D не может найти никакой информации от A, утверждающего, что он подключен к B. Из-за этого D не будет использовать канал [A, B].

Эта проверка обычно выполняется либо до того, как линия связи будет перемещена в TENT, либо до того, как линия связи будет перемещена из TENT в PATH.

# В ViPNet Coordinator

### Общие сведения о протоколе OSPF

**Протокол OSPF** — внутренний шлюзовой протокол (Interior Gateway Protocol, IGP), используется для распространения данных маршрутизации внутри одной автономной системы.

OSPF-маршрутизация работает следующим образом:
1. OSPF-маршрутизаторы устанавливают связь друг с другом посредством многоадресной (multicast) рассылки.
2. OSPF-маршрутизаторы начинают обмениваться сообщениями типа LSA (Link State Advertisements), в которых передают информацию о состоянии каналов связи с помощью однонаправленной (unicast) рассылки.
3. При получении LSA-сообщения информация из него заносится в базу данных (link state database). Если LSA-сообщение содержит новую информацию о канале связи по сравнению с той, которая содержится в базе данных, то оно передается маршрутизаторам-соседям.
4. На каждом маршрутизаторе по алгоритму Дейкстры (SPF algorithm) вычисляется множество кратчайших маршрутов ко всем сетям назначения и их стоимость. Таким образом, каждый OSPF-маршрутизатор имеет собственное представление о состоянии каналов связи и топологии сети, но при этом все маршрутизаторы используют одну базу данных состояний каналов связи для вычисления кратчайших маршрутов.

Межсетевая среда, в которой находятся OSPF-маршрутизаторы, представляется как совокупность областей маршрутизации, соединенных друг с другом через некоторую базовую область.

Выделяют следующие типы областей маршрутизации:
- Базовая или область 0 (backbone area) — с ней должны быть соединены все остальные области автономной системы.
- Стандартная (standard area) — граничит как с другими областями, так и с другими автономными системами.
- Стандартная тупиковая (stub area) — граничит только с другими областями.
- Полностью тупиковая (totally stubby area) — граничит только с одной областью.
- Не полностью тупиковая (not-so-stubby area) — стандартная тупиковая область, которая может взаимодействовать с другими автономными системами с помощью пограничных маршрутизаторов (ABR).

Каждый OSPF-маршрутизатор входит в определенную область маршрутизации и обменивается информацией только с маршрутизаторами, входящими в эту же область. При этом обмен идет не напрямую, а через посредника — маршрутизатор, выбранный главным в этой области. Информация между разными областями передается через маршрутизатор, который располагается на границе этих областей. Если автономная система взаимодействует с другой автономной системой, то информация передается через маршрутизатор, который располагается на границе систем. Такой подход позволяет уменьшить объем рассылаемых LSA-сообщений, тем самым уменьшить нагрузку на маршрутизаторы и повысить скорость построения таблиц маршрутизации.

Выделяют следующие типы маршрутизаторов:
- **Внутренний (internal router, IR)** — все его сетевые интерфейсы находятся в одной области.
- **Назначенный (designated router, DR)** — выбран главным среди всех внутренних маршрутизаторов в одной области.
- **Резервный назначенный (backup designated router, BDR)** — берет на себя функции главного в случае, если главный маршрутизатор вышел из строя.
- **Межобластной граничный (area border router, ABR)** — соединяет несколько областей OSPF одной автономной системы.
- **Граничный маршрутизатор автономной системы (autonomous system boundary router, ASBR)** — граничит с другой автономной системой, работающей по другому протоколу динамической маршрутизации (IGRP, EIGRP, IS-IS, RIP, BGP, Static).

Для проверки подлинности маршрутов, полученных с других устройств по протоколу OSPF, можно настроить аутентификацию на маршрутизаторах.
Протокол OSPF поддерживает два метода аутентификации:
- простая аутентификация на пароле (simple password authentication). Одинаковый пароль настраивается на интерфейсах, через которые передается информация по протоколу OSPF. Пароль передается в открытом виде.
- криптографическая аутентификация (cryptographic authentication). Общий секретный ключ и идентификатор ключа настраиваются на интерфейсах, через которые передается информация по протоколу OSPF. Ключ передается в зашифрованном виде (используется алгоритм хеширования md5).

Аутентификация настраивается для соседних маршрутизаторов. По умолчанию протокол OSPF не использует аутентификацию.