
> Внимание! При установке KSC 15 необходимо использовать компонент astra-ce расширенного репозитория для установки СУБД PostgreSQL 14. В данной редакции СУБД PostgreSQL не поддерживает МРД. Редакция СУБД PostgreSQL 11 (с поддержкой МРД) не поддерживается KSC 15.

Пакеты, содержащиеся в расширенном репозитории, не дорабатываются для применения в Astra Linux Special Edition и не проходят сертификационные испытания, но технически могут обновлять (заменять) пакеты, находящиеся в базовом репозитории, и доработанные для применения с **КСЗ Astra Linux Special Edition**.

Работа ПО, установленного из расширенного репозитория, как и любого другого ПО, контролируется общими правилами МРД и МКЦ, действующими в ОС. При этом ОС может работать в любом режиме защиты, однако взаимодействие КСЗ и ПО может быть ограничено. При замене пакета PostgreSQL отключается возможность использования мандатного управления доступом для записей базы данных PostgreSQL. Для обозначения того, что Astra Linux Special Edition работает с использованием таких заменяющих пакетов, используется технический термин "состояние совместимости с Astra Linux Common Edition". Пакеты с таким заменяющим ПО объединены в специальном компоненте расширенного репозитория - **компоненте astra-ce**.

Файл с указанием адресов репозиториев в качестве источников хранится в разделе `/etc/apt/sources.list`. Для его редактирования необходимо выполнить команду, а затем внести адреса репозиториев

> Для использования репозиториев по протоколу HTTPS, установить пакеты `apt-transport-https` и `ca-certificates`. Проверьте корректность установленного времени на ПК. Если установить пакеты невозможно, измените адрес репозиториев с `https` на `http`

```
# Основной репозиторий (установочный диск)
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-main/ 1.7_x86-64 main contrib non-free

# Актуальное обновление основного репозитория  
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-update/ 1.7_x86-64 main contrib non-free

# Базовый репозиторий  
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-base/ 1.7_x86-64 main contrib non-free

# Расширенный репозиторий  
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-extended/ 1.7_x86-64 main contrib non-free

# astra-ce  
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-extended/ 1.7_x86-64 astra-ce
```

Включение компoнента astra-ce:

```
sudo astra-ce https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-extended/
```

```
sudo astra-update -A -r
```

## Установка и настройка PostgreSQL 14

После добавления всех необходимых репозиториев можно приступать к установке СУБД. Для начала проверим какие версии PostgreSQL нам доступны:

```shell
sudo apt policy postgresql
```

Доступны версии 11 с поддержкой МРД и версия 14 без поддержки МРД, но только PostgreSQL 14 подходит под требования к Kaspersky Security Center, поэтому её и установим.

```shell
sudo apt install postgresql-14
```

После установки нам необходимо изменить параметры в конфигурационном файле `postgres.conf` для того, чтобы они соответствовали рекомендованным Лабораторией Касперского. Откроем файл на редактирование:

```shell
sudo nano /etc/postgresql/14/main/postgresql.conf
```

**Параметры выставляются в соответствии со следующими рекомендациями:**

- shared_buffers = 25% от объема оперативной памяти устройства, на котором установлена СУБД. Если оперативной памяти меньше 1 ГБ, то оставьте значение по умолчанию.
    
- huge_pages = try
    
- max_stack_depth = максимальный размер стека (например, вы можете получить это значение, выполнив команду 'ulimit -s' ) минус 1 МБ. Учитывайте, что команда 'ulimit -s' выдает значение в килобайтах.
    
- temp_buffers = 24MB
    
- max_prepared_transactions = 0
    
- work_mem = 16MB
    
- temp_file_limit = -1
    
- max_connections = 151
    
- fsync = on

![[Pasted image 20250205104429.png]]

![[Pasted image 20250205104437.png]]

Сохраняем файл и закрываем.

Следующим этапом нам необходимо отредактировать конфигурационный файл **pg_hba.conf**, который отвечает за безопасность доступа к СУБД. Мы будем использовать для доступа к БД специально созданную учетную запись с именем kscdbowner, её нам и необходимо задать в файле. Вы можете выбрать другое имя учетной записи, но тогда измените имя при создании УЗ на следующем этапе.

Откроем файл на редактирование:

```shell
sudo nano /etc/postgresql/14/main/pg_hba.conf
```

Добавим следующую строку в раздел “Database administrative login by Unix domain socket”  

```
local all kscadmin md5
```

![[Pasted image 20250205104537.png]]

Сохраняем файл и закрываем.

Перезапускаем службу postgresql:

```shell
sudo systemctl restart postgresql
```

Войдем под пользователем postgres в консоли:

```shell
sudo su - postgres
```

Создадим **пользователя базы данных** `kscadmin` и **базу данных** `kscdb`. Владельцем базы будет созданный нами пользователь. Установим пользователю пароль для доступа в базу, пароль необходимо использовать более надежный, но мы для примера возьмем «P@SSWORD».

```
createuser kscdbowner
createdb kscdb -O kscdbowner

psql -c "alter user kscdbowner with password «P@SSW0RD»"
```


Проверим возможность входа в базу под новым пользователем:

```
psql -U kscdbowner -d kscdb
```

Если вход выполнен успешно, то у нас откроется **консоль для работы с базой**.

Выйдем из консоли базы данных:

```
exit
```

И выйдем из консоли пользователя `postgres`:

```
exit
```

![[Pasted image 20250205113013.png]]

Теперь, когда база данных подготовлена, можно приступать к этапам развертывания KSC.

## Установка Kaspersky Security Center

**Подготовка пользователей и групп**

Для корректной работы служб KSC необходимо создать пользователя в операционной системе. Назовем его `kscadmin`.

```shell
sudo adduser kscadmin
```

При создании пользователя система запросит различные данные о нем, все они необязательные. В нашем случае, так как запись служебная, просто нажмем Enter несколько раз и оставим все поля пустыми.

Та же создадим группу для администраторов будущей KSC, называться она будет `kladmins`. Добавим пользователя `kscadmin` в новую группу и позволим ему управлять членством:

```shell
sudo groupadd kladmins  
sudo gpasswd -a kscadmin kladmins
sudo usermod -g kladmins kscadmin
```

Перейдем в каталог где лежат установочные файлы и запустим установку дистрибутива:

```shell
sudo dpkg –i ksc64_*_amd64.deb
```

В конце нас извещают об успешной установке и просят запустить скрипт для корректной настройки сервера перед началом использования.

#### Выполнение скрипта настройки

После выполнения установки нам необходимо задать некоторые параметры. Для этого мы должны запустить скрипт, который в интерактивном режиме внесет необходимые изменения.

Выполним команду:

```shell
sudo /opt/kaspersky/ksc64/lib/bin/setup/postinstall.pl
```

В начале нас попросят принять два соглашения, а далее по порядку будут уточняться вид сервера, адрес сервера, номер порта SSL для подключения агентов, планируемое количество устройств, группа безопасности для служб, имя служебной записи для запуска служб, вид базы данных, адрес и порт для доступа к базе, а также учетные данные для доступа. Заполните это в соответствии с данными по вашей инфраструктуре. Так как СУБД располагается на этом же сервере, то его адрес будет `127.0.0.1`. Важно отметить, что здесь не принимается localhost в качестве корректного значения.

![[Pasted image 20250205114225.png]]

![[Pasted image 20250205114232.png]]

```shell
# Принимаем соглашения
Y
# Принимаем соглашения
Y
# Выбираем режим KSC сервера: 1) Standard
1
# Вводим IP адрес сервера
XXX.XXX.XXX.XXX
# SSL порт (оставляем по умолчанию)
<Enter>
# Определяем сколько устройств будет обрабатывать сервер
2
# Определяем группу для сервисов KSC (создавали kscadmin)
kladmins
# Определяем пользователя для запуска сервиса Сервера Администрирования KSC (создавали kscadmin)
kscadmin
# Определяем пользователя для запуска остальных сервисов (создавали kscadmin)
kscadmin
# Выбираем тип БД (у нас PostgreSQL14)
2
# Вводим адрес подключения БД
127.0.0.1
# Вводим порт БД
5432
# Определяем имя БД (создавали kscdb)
kscdb
# Определяем пользователя БД (создавали kscadmin)
kscadmin
# Вводим пароль от пользователя БД kscadmin
<password>
```

После ввода пароля для доступа к базе данных, скрипт начнет производить необходимые изменения с базой данных и службами. Дождемся окончания. В конце скрипт попросит вас указать имя главного администратора системы и пароль, позже он понадобится для доступа в веб-консоль. Мы укажем имя `osfradmin`.

```shell
# Вводим имя пользователя сервера администрирования
osfradmin
# Придумываем ему пароль
<password>
```

На этом установка и настройка сервера Kaspersky Security Center успешно завершена. Вы можете **запустить следующие команды**, чтобы проверить статус служб:

```shell
sudo systemctl status klnagent_srv.service
sudo systemctl status kladminserver_srv.service
sudo systemctl status klactprx_srv.service
sudo systemctl status klwebsrv_srv.service
```

Все службы должны быть в статусе `active (running)`.

### Установка веб-консоли KSC Web Console

Для управления сервером KSC на Astra Linux используется веб-консоль. Служба веб-консоли может располагаться как на отдельном сервере, так и совместно с сервером KSC. Мы установим веб-консоль на сервер KSC для простоты.

Первым делом нам необходимо сформировать так называемый файл ответов. В нем должны быть заданы все необходимые параметры для автоматизированной установки службы веб-консоли. Создадим файл и откроем его на редактирование:

```shell
sudo nano /etc/ksc-web-console-setup.json
```

Внесем туда следующий текст:

```
{
  "address": "10.10.30.232",
  "port": 8080,
  "trusted": "127.0.0.1|13299|/var/opt/kaspersky/klnagent_srv/1093/cert/klserver.cer|KSC Server",
  "acceptEula": true
}
```

**Расшифровка полей:**

- **address** – адрес, по которому будет осуществляться доступ к консоли;
    
- **port** – порт, по которому будет осуществляться доступ к консоли;
    
- **trusted** – параметры подключения к серверу KSC, путь к сертификату KSC, имя сервера;
    
- **acceptEula** – принятие лицензионного соглашения.
    

Лицензионное соглашение может быть загружено с сайта Лаборатории Касперского, там же ранее мы скачивали дистрибутивы.

![[Pasted image 20250205121722.png]]

Сохраним файл и закроем.

Запустим установку веб-консоли:

```shell
sudo dpkg –i ksc-web-console-*.x86_64.deb
```

От нас не потребуется никаких действий до окончания установки. После её завершения необходимо перезапустить все службы KSC:

```
sudo systemctl restart KSC*
```

Проверим работу веб-консоли, перейдя в браузере по адресу https://10.10.30.232:8080. Если вы получили страницу входа, значит веб-консоль успешно работает.

![[Pasted image 20250205122234.png]]

Используйте логин и пароль администратора, указанный при установке KSC, для доступа к инструментам администрирования, в нашем случае это Administrator. После входа запустится мастер первоначальной настройки, с его помощью вы сможете настроить основные политики, задачи, активировать программу и прочее.

### Сравнение KSC на базе Linux и Windows

К сожалению, на текущий момент, Kaspersky Security Center на базе Linux уступает по функциональным возможностям своей версии для платформы Windows, но Лаборатория Касперского постоянно работает над улучшением обоих продуктов.

**В релизе 14.2** Kaspersky Security Center на базе Linux получил поддержку клиентов Kaspersky Endpoint Security на базе ОС Windows, что открывает дополнительные возможности по миграции существующих инфраструктур. Ниже представлена таблица сравнения отличий в функциональных возможностях KSC 14.2 на базе Windows и на базе Linux.

|Функция или свойство|Kaspersky Security Center Решение на базе Windows|Kaspersky Security Center Решение на базе Linux|
|---|---|---|
|Операционная система для установки Сервера администрирования|Windows|Linux|
|Тип Консоли администрирования|Локальная и веб-интерфейс|Веб-интерфейс|
|Опрос сети|+|+ (только по IP-диапазонам)|
|Максимальное количество управляемых устройств|100 000|20 000|
|Защита устройств под управлением Windows, macOS и Linux|+|+ (защита устройств только с операционными системами Linux и Windows)|
|Защита мобильных устройств|+|-|
|Защита виртуальных машин|+|-|
|Защита публичной облачной инфраструктуры|+|-|
|Установка обновлений программ сторонних производителей и поиск уязвимостей в программах сторонних производителей|+|- (только с помощью задачи удаленной установки)|
|Использование SNMP для отправки статистики Сервера администрирования программам сторонних производителей|+|-|
|Удаленная диагностика клиентских устройств|+|-|
|Удаленное подключение к рабочему столу клиентского устройства|+|-|
|Автоматическое обновление программ "Лаборатории Касперского"|+|-|
|Развертывание операционных систем на клиентских устройствах|+|-|
|Веб-сервер для публикации инсталляционных пакетов и других файлов|+|-|
|Управление сторонними лицензиями|+|-|
Полное сравнение вы можете посмотреть в онлайн справке на сайте Лаборатории Касперского: [Сравнение версий Kaspersky Security Center: на базе Windows и на базе Linux](https://support.kaspersky.com/help/KSCLinux/14.2/ru-RU/211055.htm)

