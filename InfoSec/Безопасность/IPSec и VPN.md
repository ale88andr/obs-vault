
В сегодняшней статье речь пойдет о способах организации виртуальных частных сетей **VPN (Virtual Private Network)**. VPN – это набор криптографических механизмов, обеспечивающих защищенный, двухсторонний канал для безопасной передачи данных через незащищенную сеть, такую как Интернет. Благодаря VPN пользователь может получить доступ к удаленной сети и работать с её ресурсами так, как если бы он находился внутри нее. Поэтому VPN получил широкое распространение у компаний, имеющих в своем штабе дистанционных сотрудников.

---

### Терминология

VPN представляет собой соединение типа Point to point (точка-точка), которое принято называть “туннелем” (tunnel), а участников данного соединения – “пирами” (peer). Каждый пир шифрует данные, подлежащие передаче через туннель и дешифрует данные, которые получает из туннеля.

Если к одному пиру устанавливается несколько туннелей, то такой пир называется VPN – шлюзом, а сеть, находящаяся за ним – “доменом шифрования” (encryption domain). Несмотря на название, трафик внутри домена шифрования не шифруется, так как считается защищенным от попадания во внешнюю сеть. Кроме того, VPN – туннель может быть установлен между сетями.

Удаленный сотрудник, желающий настроить VPN - туннель с доменом шифрования своего офиса, должен установить на своей рабочей станции специальное ПО – VPN-клиент, например: OpenVPN, VyprVPN, TunnelBear и др.

Для большего понимания, на рисунке ниже отмечены все элементы, рассмотренные ранее:

![[Pasted image 20240122120516.png]]Разберем основные принципы, по которым устанавливается VPN – соединение.

1. Перед установлением соединения пиры идентифицируют друг друга, чтобы удостовериться, что шифрованный трафик будет отправлен правильному получателю.
2. Пиры договариваются, по каким протоколам будет устанавливаться соединение для сохранения целостности и конфиденциальности данныхю
3. Создается ключ, который будет использоваться для шифрования и дешифрования данных

Существует множество механизмов, способных обеспечить выполнение данных функций, но мы рассмотрим самый распространенный - IPsec(IP Security).

IPsec – это целый набор протоколов, обеспечивающих сервисы приватности и аутентификации. Обычно в IPsec выделяют три основных протокола:

1. **AH (Authentication Header)** – протокол идентификации заголовка. Данный протокол обеспечивает защиту передаваемых данных от изменения, путем проверки каждого бита пакета после передачи. То есть обеспечивает функции целостности.
2. **ESP (Encapsulating Security Protocol)** Данный протокол обеспечивает не только функции целостности, но и конфиденциальности, путем добавления своего заголовка в пакет, подлежащий защите.
3. **IKE (Internet Key Exchange protocol)** – протокол обмена ключами. Данный протокол предназначен для автоматического генерирования, обновления и обмена ключами между участниками VPN – соединения.

В IPsec есть еще один важный термин – SA (Security Association). SA это непосредственно VPN – соединение в контексте IPsec. SA устанавливается сразу после того, как IPsec – узлы договорились и согласовали все параметры, по которым будет организован VPN – туннель.

Итак, VPN – соединение с использованием IPsec устанавливается в два этапа:

На первом этапе VPN – узлы идентифицируют друг друга и согласовывают алгоритмы шифрования, хэширования и аутентификации, после чего создается первый SA.

Второй этап возможен только после завершения первого. На втором этапе генерируются данные ключей и происходит согласование используемой политики. После завершения второй фазы формируется второй SA и все данные, подлежащие передаче, шифруются. Именно после второго этапа формируется VPN – туннель и установка считается завершенной.

---

_IPsec (Internet Protocol Security)_ — это набор протоколов, которые взаимодействуют друг с другом для обеспечения безопасной передачи IP-пакетов по незащищенным сетям.

_IP-пакет_ — это блок данных, который передается по компьютерной сети. Он имеет определенную структуру и состоит из трех основных компонентов:

![[Pasted image 20240627111051.png]]

1. Заголовок — содержит информацию об адресе отправителя и получателя и типе данных.
2. Полезная нагрузка — информация, которую хочет передать пользователь.
3. Трейлер — дополнительная информация.

Протоколы IPsec используют, чтобы передаваемые данные сохранили:

- **Целостность** — защита данных от потери, изменения, а также дублирования при передаче.
- **Аутентичность** — данные будут переданы от надежного источника.
- **Конфиденциальность** — зашифрованные данные защищены от несанкционированного просмотра.

Сетевые соединения по умолчанию не зашифрованы. Например, протоколы сетевого взаимодействия TCP/IP предназначены только для подключения и доставки. При этом передаваемые данные открыты и доступны для просмотра третьими лицами. Именно поэтому для обеспечения безопасной передачи данных необходимо использовать протоколы безопасности IPsec. Они создают своеобразную оболочку вокруг данных, которые отправляются по незащищенным сетям, тем самым обеспечивая безопасность передачи.

## Архитектура IPsec

![[Pasted image 20240627111359.png]]
### Первый уровень

Здесь расположены [AH](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-ah) и [ESP](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-esp) протоколы, которые защищают данные на всех этапах процесса передачи. Именно эти протоколы реализуют основные функции IPsec — аутентификацию и шифрование данных и являются ключевыми элементами IPsec.

#### Протокол AH (Authentifitication Header)

Протокол AH обеспечивает:

- Аутентификацию — пользователь может убедиться, что действительно взаимодействует с теми, кого он ожидает.
- Целостность передаваемых данных — пользователь может обнаружить изменение данных в процессе передачи.
- Защиту данных от воспроизведения — данные не могут быть воспроизведены в сети злоумышленниками.

Протокол AH создает очень надежную защиту для содержимого IP-пакета, поскольку следит за тем, чтобы в него не было внесено каких-либо изменений. Однако, это же делает его несовместимым с сетевым режимом NAT (Network Address Translation). Такое ограничение связано с тем, что NAT преобразует IP-адреса при передаче IP-пакетов.

Также в протоколе AH не предусмотрены средства защиты конфиденциальности переданных данных — злоумышленники не смогут изменить данные, но при этом могут их прочитать.

#### Протокол ESP (Encapsulating Security Payload)

Протокол ESP, так же как и AH, обеспечивает аутентификацию и целостность IP-пакета. Однако, помимо это он еще применяется для сохранения конфиденциальности передаваемых данных с помощью шифрования. При этом для ESP необязательно задействование всех этих функций одновременно. Однако, алгоритмы обеспечения конфиденциальности данных необходимо использовать в любом случае.

Обычно протоколы ESP и AH применяют независимо, хотя их совместное применение также возможно.

### Второй уровень

Функции IPsec реализуются с помощью конкретных алгоритмов, расположенных на втором уровне архитектуры.

Аутентификация в IPsec реализуется при помощи специальных алгоритмов в протоколах AH и ESP. Так, например, стандартные для IPsec алгоритмы аутентификации [HMAC](https://ru.wikipedia.org/wiki/HMAC) используют общий секретный ключ для участников соединения. Алгоритмы HMAC являются обязательными для протокола AH и факультативными — для ESP. Подробнее о процессе аутентификации читайте в разделе [Аутентификация в IPsec](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-authentication).

Протокол ESP также поддерживает разные алгоритмы шифрования. Среди них — DES, 3 DES и AES. Это помогает еще больше защитить IP-пакет — чтобы получить доступ к информации, необходимо не только расшифровать данные, но и понять, какие именно алгоритмы применялись для шифрования. Подробнее о шифровании читайте в разделе [Шифрование в IPsec](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-encryption).

### Третий уровень

Здесь расположен DOI — домен интерпретации. Это элемент, который хранит информацию об алгоритмах и протоколах, которые были применены. Применение DOI обусловлено тем, что протоколы AH и ESP могут поддерживать разные алгоритмы.

### Четвертый уровень — Протокол IKE (Internet Key Exchange)

Протокол IKE — своего рода фундамент IPsec. Он применяется для создания политики безопасности соединения, благодаря этому отправитель и получатель могут согласовать, с помощью каких алгоритмов будет выполнена аутентификация и шифрование. Также этот протокол обеспечивает генерацию и распределение ключей между участниками защищенного соединения.

## Функции IPsec

Рассмотрим подробнее функции IPsec — [аутентификацию](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-authentication), [шифрование](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-encryption) и [управление ключами](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-key-management), а также способы их реализации

### Аутентификация в IPsec

Аутентификация — это необходимый элемент обеспечения защиты передаваемого IP-паекта.

Она нужна, чтобы пользователь был уверен в подлинности:

- содержания IP-пакета — исходные данные не изменялись, их целостность не нарушена, они недоступны для повторной передачи.
- отправителя данных — исходные данные были созданы именно тем, кем заявлено.

Аутентификация выполняется при помощи ключей, [симметричных или асимметричных](https://yandex.cloud/ru/docs/glossary/ipsec#symmetric-and-asymmetric-encryption). Чтобы обеспечить безопасность данных, эти ключи необходимо периодически обновлять у обеих сторон одновременно, это называется _распределением ключей_.

Важно, что IPsec не определяет жестко, каким именно методом должна быть выполнена аутентификация. Участники соединения сами выбирают и согласовывают наиболее удобный для себя вариант. Аутентификация с помощью цифрового сертификата и предварительным обменом ключами — два наиболее распространенных способа. Рассмотрим их подробнее.

#### Предварительный обмен ключами (Pre-Shared Key, PSK)

_Предварительный обмен ключами_ — это метод аутентификации, который основан на предварительном распределении ключей между участниками обмена данными. После установления общего ключа, они могут использовать его как для шифрования, так и для расшифровки данных.

Такой способ аутентификации предполагает использование алгоритма [Диффи-Хеллмана](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB_%D0%94%D0%B8%D1%84%D1%84%D0%B8_%E2%80%94_%D0%A5%D0%B5%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD%D0%B0). Он реализует систему открытого распределения ключей, при котором изначально ключа нет ни у отправителя, ни у получателя. Общий закрытый ключ они вычисляют с помощью секретного парамера и обмена сообщениями.

**Плюсы предварительного обмена ключами**:

- Простота — предварительный обмен ключами легко настроить, кроме того, он может использоваться в различных приложениях.
- Безопасность — данные надежно защищены, поскольку ключ знают только отправитель и получатель.
- Быстрота — предварительный обмен ключами быстро шифрует и дешифрует данные, что делает его использование удобным при большом количестве участников связи, а также при необходимости частой замены ключей.

**Минусы предварительного обмена ключами**:

- Ограничения — предварительный обмен ключами предполагает лимиты на длину ключа и количество участников, которые могут использовать его.
- Уязвимость — может быть скомпрометирован, если ключ становится известен третьим лицам.
- Риск утечки — в случае компрометации ключа, под угрозой расшифровывания окажутся все данные, для которых применялся этот ключ.

#### Цифровой сертификат

_Цифровой сертификат_ – это специальный электронный документ, который центр сертификации или удостоверяющий центр выдает пользователю. Он содержит информацию о владельце сертификата, которая нужна для проверки подлинности его личности — открытый ключ. Когда отправитель отправляет данные через IPSec, он должен предоставить свой цифровой сертификат, который будет проверен получателем.

Последовательность выполнения аутентификации с помощью цифрового сертификата:

1. Отправитель создает цифровой сертификат и подписывает его своим закрытым ключом.
2. Отправитель пересылает IP-пакет вместе со своим цифровым сертификатом через IPSec.
3. Получатель проверяет подлинность цифрового сертификата, а также соответствие открытого ключа из сертификата открытому ключу, которым был подписан IP-пакет.
4. Если проверка прошла успешно, получатель принимает данные и обрабатывает их.

**Преимущества цифрового сертификата**:

- Безопасность — цифровые сертификаты защищены криптографией, благодаря чему они практически неуязвимыми для фальсификации или взлома.
- Удобство использования — при использовании цифровых сертификатов для аутентификации в протоколе безопасности IPsec пользователь может легко и быстро получать доступ к защищенным данным.

**Недостатки цифрового сертификата**:

- Стоимость — иногда использование цифровых сертификатов требует значительных денежных затрат, что может стать существенным недостатком для малых и средних предприятий.
- Сложность настройки — настройка цифровых сертификатов может потребовать определенных знаний и навыков.

#### Защита от атак MITM

Защита от атак типа MITM (Man-in-the-Middle — человек посередине) является одной из главных задач обеспечения безопасности данных. При такой атаке злоумышленник встает между участниками связи. Благодаря этому он может перехватить закрытый ключ и получить доступ к передаваемым IP-пакетам. При этом стороны часто даже не подозревают о том, что общаются не напрямую, а их данные перехватываются и изменяются злоумышленниками.

Аутентификация с помощью цифровых сертификатов позволяет избежать MITM-атак, поскольку обмен закрытыми ключами недоступен третьим лицам.

Распределение ключей методом Диффи-Хеллмана в его оригинальном виде может быть уязвимо для MITM-атак. Поэтому метод Диффи-Хеллмана обычно применяют совместно с дополнительной односторонней или двусторонней аутентификацией. Это помогает обеспечить безопасность передаваемых данных.

В итоге методы аутентификации в IPsec могут быть настроены таким образом, что атаки типа MITM не будут представлять опасности для IP-пакета.

### Шифрование в IPsec

Шифрование — одна из важнейших функций IPsec, защищает IP-пакеты от доступа третьих лиц. Оно обеспечивает передаваемым данным:

- **Конфиденциальность**  
    IPsec использует протокол [ESP](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-esp), чтобы обеспечить конфиденциальность и целостность передаваемых данных. Он инкапсулирует передаваемый IP-пакет с помощью различных алгоритмов шифрования, выбор которых зависит от требований сторон к безопасности.
    
- **Целостность данных**  
    IPsec использует протокол [AH](https://yandex.cloud/ru/docs/glossary/ipsec#ipsec-ah), чтобы обеспечить целостность передаваемых данных. Проверка целостности IP-пакета может быть проведена различными алгоритмами аутентификации, выбор которых зависит от требований сторон к безопасности.
    

#### Симметричное и асимметричное шифрование в IPsec

_Симметричное шифрование_ — это метод шифрования данных, при котором участники связи используют один и тот же секретный ключ. Отправитель применяет этот ключ для шифрования IP-пакета, а получатель — для его расшифровки. К плюсам этого способа шифрования можно отнести скорость, а также простоту реализации. К минусам — критичность к надежности канала передачи ключа, а также сложность управления ключами в большой сети.

_Асимметричное шифрование_ — это метод шифрования данных, при котором участники связи используют разные ключи — открытый и закрытый. Отправитель использует открытый ключ для шифрования IP-пакета. Получатель использует закрытый ключ для его расшифровки. Такой тип шифрования более безопасный, так как злоумышленник не сможет расшифровать данные без закрытого ключа. Однако, в этом случае реализация шифрования сложнее, а скорость — ниже, чем у симметричного шифрования.

В IPsec используются оба этих типа шифрования, но обычно для разных целей. Симметричное шифрование обычно применяется для защиты IP пакетов между устройствами, такими как маршрутизаторы и коммутаторы, а асимметричное — для защиты пакетов, передаваемых в интернете.

#### Транспортный и туннельный режимы шифрования

Протоколы безопасности IPSec могут работать в одном из следующих режимов:

1. **Туннельный режим**  
    Туннельный режим IPSec используется для создания безопасного соединения WAN и VPN, использующих интернет в качестве среды подключения. В этом режиме протоколы IPSec шифруют заголовок и полезную нагрузку IP-пакеты. Таким образом данные, содержащиеся в этом пакете, инкапсулируются внутри дополнительного пакета, который и будет отправлен.

![[Pasted image 20240627112024.png]]
Как происходит обмен данными, когда туннельный режим определен как режим IPSec:

1. Данные передаются с использованием незащищенного IP-пакета с компьютера в частной сети.
2. Когда пакет поступает на маршрутизатор, он инкапсулирует его, используя протоколы безопасности IPSec.
3. Маршрутизатор пересылает пакет на другой конец соединения.
4. Маршрутизатор, принимающий IP-пакет проверяет его целостность.
5. Пакет расшифровывается.
6. Данные пакета отправляются на компьютер получателя в частной сети.

Таким образом, туннельный режим применяется, когда две частные сети передают данные через публичную незащищенную сеть. Например, при передаче IP-пакета:
- От сервера к серверу;
- От сервера к шлюзу;
- От шлюза к шлюзу.

2. **Транспортный режим**  
    Основное отличие транспортного режима от туннельного в том, что в транспортном режиме работы шифруется не весь IP-пакет, а только полезная нагрузка.

![[Pasted image 20240627112058.png]]
Транспортный режим шифрования используется когда между двумя устройствами уже существует IP-связь, но она небезопасна. Например, при передаче IP-пакета от сервера к клиенту.

Часто сети, не способные поддерживать туннельный режим, успешно работают в транспортном режиме.















