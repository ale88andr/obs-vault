В этом разделе мы представим концепцию уязвимостей бизнес‑логики и объясним, как они могут возникать из‑за ошибочных предположений о поведении пользователей. Мы обсудим потенциальное влияние логических ошибок и покажем, как они могут эксплуатироваться. Вы также сможете попрактиковаться в том, что узнали, используя наши интерактивные лабораторные задания, основанные на реальных ошибках, с которыми мы сталкивались на практике. Наконец, мы предоставим несколько общих рекомендаций, которые помогут вам предотвратить появление подобных логических ошибок в ваших собственных приложениях.

![[logic-flaws.jpg]]

## Что такое уязвимости бизнес‑логики?

Уязвимости бизнес‑логики — это изъяны в проектировании и реализации приложения, которые позволяют злоумышленнику вызвать непредусмотренное поведение. Это потенциально даёт возможность злоумышленникам манипулировать легитимной функциональностью для достижения вредоносной цели. Эти изъяны, как правило, являются результатом неспособности предвидеть необычные состояния приложения, которые могут возникнуть, и, как следствие, неспособности безопасно их обработать.

**Примечание** В этом контексте термин «бизнес‑логика» просто относится к набору правил, которые определяют, как работает приложение. Так как эти правила не всегда напрямую связаны с бизнесом, соответствующие уязвимости также известны как «уязвимости логики приложения» или просто «логические изъяны».

Логические изъяны часто невидимы для людей, которые специально их не ищут, так как они обычно не проявляются при нормальном использовании приложения. Однако злоумышленник может эксплуатировать поведенческие особенности, взаимодействуя с приложением способами, которые разработчики никогда не предусматривали.

Одной из основных целей бизнес‑логики является обеспечение выполнения правил и ограничений, определённых при проектировании приложения или функциональности. В целом бизнес‑правила диктуют, как приложение должно реагировать, когда происходит определённый сценарий. Это включает предотвращение действий пользователей, которые могут негативно повлиять на бизнес или просто не имеют смысла.

Изъяны в логике могут позволить злоумышленникам обойти эти правила. Например, они могут завершить транзакцию, не проходя через предусмотренный процесс покупки. В других случаях сломанная или отсутствующая проверка данных, предоставленных пользователем, может позволить пользователям вносить произвольные изменения в критически важные для транзакции значения или отправлять бессмысленный ввод. Передавая неожиданные значения в серверную логику, злоумышленник потенциально может заставить приложение делать то, что оно не должно делать.

Уязвимости, основанные на логике, могут быть чрезвычайно разнообразными и часто уникальны для конкретного приложения и его функциональности. Их выявление часто требует определённых человеческих знаний, таких как понимание бизнес‑доменов или того, какие цели может преследовать злоумышленник в данном контексте. Это делает их трудными для обнаружения с помощью автоматизированных сканеров уязвимостей. В результате логические изъяны являются отличной целью для охотников за багами и ручных тестировщиков в целом.

## Как возникают уязвимости бизнес‑логики?

Уязвимости бизнес‑логики часто возникают потому, что команды проектирования и разработки делают ошибочные предположения о том, как пользователи будут взаимодействовать с приложением. Эти неверные предположения могут привести к недостаточной проверке пользовательского ввода. Например, если разработчики предполагают, что пользователи будут передавать данные исключительно через веб‑браузер, приложение может полностью полагаться на слабые клиентские средства проверки ввода. Эти средства легко обходятся злоумышленником с помощью перехватывающего прокси.

В конечном счёте это означает, что когда злоумышленник отклоняется от ожидаемого поведения пользователя, приложение не предпринимает соответствующих шагов для предотвращения этого и, как следствие, не справляется с ситуацией безопасно.

Логические изъяны особенно распространены в чрезмерно сложных системах, которые даже сама команда разработчиков не полностью понимает. Чтобы избежать логических изъянов, разработчики должны понимать приложение в целом. Это включает осведомлённость о том, как разные функции могут комбинироваться неожиданными способами. Разработчики, работающие с большими кодовыми базами, могут не иметь глубокого понимания того, как работают все области приложения. Кто‑то, работающий над одним компонентом, может сделать ошибочные предположения о том, как работает другой компонент, и в результате непреднамеренно ввести серьёзные логические изъяны. Если разработчики явно не документируют предположения, которые они делают, такие уязвимости легко могут проникнуть в приложение.

## Каково влияние уязвимостей бизнес‑логики?

Влияние уязвимостей бизнес‑логики иногда может быть довольно тривиальным. Это широкая категория, и последствия сильно варьируются. Однако любое непредусмотренное поведение потенциально может привести к атакам высокой степени серьёзности, если злоумышленник сможет правильно манипулировать приложением. По этой причине странности логики желательно исправлять, даже если вы сами не можете понять, как их эксплуатировать. Всегда существует риск, что кто‑то другой сможет.

По сути, влияние любого логического изъяна зависит от того, с какой функциональностью он связан. Если изъян находится в механизме аутентификации, например, это может серьёзно повлиять на общую безопасность. Злоумышленники могут потенциально использовать это для повышения привилегий или полного обхода аутентификации, получая доступ к конфиденциальным данным и функциональности. Это также открывает увеличенную поверхность атаки для других эксплойтов.

Ошибки логики в финансовых транзакциях могут, очевидно, привести к огромным потерям для бизнеса через кражу средств, мошенничество и так далее.

Также следует отметить, что даже если логические изъяны не позволяют злоумышленнику напрямую извлечь выгоду, они всё равно могут позволить злонамеренной стороне каким‑то образом нанести ущерб бизнесу.

## Каковы примеры уязвимостей бизнес‑логики?

Лучший способ понять уязвимости бизнес‑логики — это рассмотреть реальные случаи и извлечь уроки из допущенных ошибок. Мы предоставили конкретные примеры различных распространённых логических изъянов, а также некоторые преднамеренно уязвимые веб‑сайты, чтобы вы могли попрактиковаться в эксплуатации этих уязвимостей самостоятельно.

## Как предотвратить уязвимости бизнес‑логики

Вкратце, ключи к предотвращению уязвимостей бизнес‑логики заключаются в следующем:

- Убедитесь, что разработчики и тестировщики понимают домен, которому служит приложение.
- Избегайте неявных предположений о поведении пользователей или о поведении других частей приложения.

Вы должны определить, какие предположения вы сделали о состоянии на стороне сервера, и реализовать необходимую логику для проверки того, что эти предположения выполняются. Это включает в себя обеспечение того, что значение любого ввода является разумным, прежде чем продолжить.

Также важно убедиться, что как разработчики, так и тестировщики могут полностью понять эти предположения и то, как приложение должно реагировать в различных сценариях. Это может помочь команде выявить логические изъяны как можно раньше. Чтобы облегчить это, команда разработки должна по возможности придерживаться следующих передовых практик:

- Поддерживать чёткие проектные документы и потоки данных для всех транзакций и рабочих процессов, отмечая любые предположения, сделанные на каждом этапе.
- Писать код как можно более ясно. Если трудно понять, что должно происходить, будет трудно выявить какие‑либо логические изъяны. В идеале хорошо написанный код не должен нуждаться в документации для понимания. В случаях неизбежной сложности создание чёткой документации имеет решающее значение, чтобы другие разработчики и тестировщики знали, какие предположения делаются и каково именно ожидаемое поведение.
- Отмечать любые ссылки на другой код, который использует каждый компонент. Подумайте о любых побочных эффектах этих зависимостей, если злонамеренная сторона попытается манипулировать ими необычным образом.

Из‑за относительно уникальной природы многих логических изъянов легко отмахнуться от них как от разовой ошибки, вызванной человеческим фактором, и двигаться дальше. Однако, как мы показали, эти изъяны часто являются результатом плохих практик на начальных этапах создания приложения. Анализ того, почему логический изъян существовал изначально и как команда его упустила, может помочь выявить слабые места в ваших процессах. Внося небольшие корректировки, вы можете повысить вероятность того, что подобные изъяны будут устранены в зародыше или выявлены раньше в процессе разработки.

## Примеры уязвимостей бизнес‑логики

Уязвимости бизнес‑логики относительно специфичны для контекста, в котором они возникают. Однако, хотя отдельные случаи логических изъянов сильно различаются, они могут иметь много общих тем. В частности, их можно условно сгруппировать на основе первоначальных ошибок, которые изначально привели к уязвимости.

В этом разделе мы рассмотрим примеры некоторых типичных ошибок, которые совершают команды проектирования и разработки, и покажем, как они могут напрямую привести к изъянам бизнес‑логики. Независимо от того, разрабатываете ли вы собственные приложения или проводите аудит существующих, вы можете извлечь уроки из этих примеров и применить то же критическое мышление к другим приложениям, с которыми вы сталкиваетесь.

Примеры логических изъянов включают:

- Чрезмерное доверие к контролям на стороне клиента
- Неспособность обрабатывать нетипичный ввод
- Ошибочные предположения о поведении пользователей
- Уязвимости, специфичные для домена
- Предоставление «оракула шифрования»
- Несоответствия в парсинге адресов электронной почты

## Чрезмерное доверие к контролям на стороне клиента

Фундаментально ошибочным предположением является то, что пользователи будут взаимодействовать с приложением только через предоставленный веб‑интерфейс. Это особенно опасно, потому что ведёт к дальнейшему предположению, что проверка на стороне клиента предотвратит ввод пользователями вредоносных данных. Однако злоумышленник может просто использовать такие инструменты, как Burp Proxy, чтобы изменить данные после того, как они были отправлены браузером, но до того, как они будут переданы в серверную логику. Это фактически делает клиентские проверки бесполезными.

Принятие данных «на веру», без выполнения надлежащих проверок целостности и валидации на стороне сервера, может позволить злоумышленнику нанести всевозможный ущерб при относительно минимальных усилиях. Точно то, чего он сможет достичь, зависит от функциональности и того, что именно делается с контролируемыми данными. В правильном контексте такого рода изъян может иметь разрушительные последствия как для бизнес‑функциональности, так и для безопасности самого веб‑сайта.

## Неспособность обрабатывать нетипичный ввод

Одной из целей логики приложения является ограничение пользовательского ввода значениями, которые соответствуют бизнес‑правилам. Например, приложение может быть спроектировано так, чтобы принимать произвольные значения определённого типа данных, но логика определяет, допустимо ли это значение с точки зрения бизнеса. Многие приложения включают числовые ограничения в свою логику. Это могут быть лимиты, предназначенные для управления запасами, применения бюджетных ограничений, запуска этапов цепочки поставок и так далее.

Возьмём простой пример интернет‑магазина. При заказе товаров пользователи обычно указывают количество, которое они хотят заказать. Хотя теоретически любое целое число является допустимым вводом, бизнес‑логика может, например, запрещать пользователям заказывать больше единиц товара, чем есть в наличии.

Чтобы реализовать такие правила, разработчики должны предусмотреть все возможные сценарии и встроить способы их обработки в логику приложения. Другими словами, они должны указать приложению, следует ли разрешать данный ввод и как оно должно реагировать в зависимости от различных условий. Если нет явной логики для обработки конкретного случая, это может привести к неожиданному и потенциально эксплуатируемому поведению.

Например, числовой тип данных может принимать отрицательные значения. В зависимости от связанной функциональности может не иметь смысла, чтобы бизнес‑логика это позволяла. Однако если приложение не выполняет достаточную проверку на стороне сервера и не отклоняет такой ввод, злоумышленник может передать отрицательное значение и вызвать нежелательное поведение.

Рассмотрим перевод средств между двумя банковскими счетами. Эта функциональность почти наверняка проверяет, есть ли у отправителя достаточные средства, прежде чем завершить перевод:

```php
$transferAmount = $_POST['amount'];
$currentBalance = $user->getBalance();

if ($transferAmount <= $currentBalance) {
    // Завершить перевод
} else {
    // Заблокировать перевод: недостаточно средств
}
```

Но если логика недостаточно предотвращает возможность передачи пользователем отрицательного значения в параметре суммы, это может быть использовано злоумышленником для обхода проверки баланса и перевода средств в «неправильном» направлении. Если злоумышленник отправил -1000 долларов на счёт жертвы, это могло бы привести к тому, что он сам получил бы 1000 долларов от жертвы. Логика всегда будет оценивать, что -1000 меньше текущего баланса, и одобрит перевод.

Простые логические изъяны такого рода могут быть разрушительными, если они возникают в критически важной функциональности. Их также легко упустить как при разработке, так и при тестировании, особенно учитывая, что такой ввод может блокироваться клиентскими проверками в веб‑интерфейсе.

При аудите приложения вы должны использовать такие инструменты, как Burp Proxy и Repeater, чтобы попробовать отправить нетипичные значения. В частности, попробуйте ввод в диапазонах, которые легитимные пользователи вряд ли когда‑нибудь введут. Это включает исключительно большие или исключительно маленькие числовые значения и аномально длинные строки для текстовых полей. Вы также можете попробовать неожиданные типы данных. Наблюдая за ответом приложения, вы должны попытаться ответить на следующие вопросы:

- Налагаются ли какие‑либо ограничения на данные?
- Что происходит, когда вы достигаете этих ограничений?
- Выполняется ли какая‑либо трансформация или нормализация вашего ввода?

Это может выявить слабую проверку ввода, которая позволяет манипулировать приложением необычными способами. Имейте в виду, что если вы находите одну форму на целевом веб‑сайте, которая не справляется с безопасной обработкой нетипичного ввода, вероятно, что и другие формы будут иметь те же проблемы.

## Ошибочные предположения о поведении пользователей

Одной из самых распространённых коренных причин уязвимостей логики является создание ошибочных предположений о поведении пользователей. Это может привести к широкому спектру проблем, когда разработчики не учитывают потенциально опасные сценарии, нарушающие эти предположения. В этом разделе мы приведём несколько предостерегающих примеров распространённых предположений, которых следует избегать, и покажем, как они могут привести к опасным логическим изъянам.

### Доверенные пользователи не всегда останутся надёжными

Приложения могут казаться безопасными, потому что они реализуют, на первый взгляд, надёжные меры для обеспечения выполнения бизнес‑правил. К сожалению, некоторые приложения совершают ошибку, предполагая, что после прохождения этих строгих проверок изначально пользователь и его данные могут доверяться бесконечно. Это может привести к относительно слабому применению тех же самых мер контроля в дальнейшем.

Если бизнес‑правила и меры безопасности не применяются последовательно во всём приложении, это может привести к потенциально опасным лазейкам, которые могут быть использованы злоумышленником.

## Пользователи не всегда будут предоставлять обязательный ввод

Одно из заблуждений заключается в том, что пользователи всегда будут указывать значения для обязательных полей ввода. Браузеры могут препятствовать тому, чтобы обычные пользователи отправляли форму без обязательного ввода, но, как мы знаем, злоумышленники могут изменять параметры во время передачи. Это даже распространяется на полное удаление параметров.

Это особенно проблематично в случаях, когда несколько функций реализованы в одном и том же серверном скрипте. В таком случае наличие или отсутствие определённого параметра может определять, какой код будет выполнен. Удаление значений параметров может позволить злоумышленнику получить доступ к веткам кода, которые должны быть недоступны.

При проверке на наличие логических изъянов вы должны попробовать удалять каждый параметр по очереди и наблюдать, какой эффект это оказывает на ответ. Вы должны убедиться, что:

- Удаляете только один параметр за раз, чтобы гарантировать достижение всех соответствующих веток кода.
    
- Пробуете удалять как имя параметра, так и его значение. Сервер, как правило, обрабатывает оба случая по‑разному.
    
- Проходите многоэтапные процессы до конца. Иногда вмешательство в параметр на одном шаге оказывает эффект на другой шаг дальше по рабочему процессу.
    

Это относится как к параметрам URL, так и к параметрам POST, но не забудьте также проверить cookies. Этот простой процесс может выявить странное поведение приложения, которое потенциально может быть использовано.

## Пользователи не всегда будут следовать предполагаемой последовательности

Многие транзакции зависят от предопределённых рабочих процессов, состоящих из последовательности шагов. Веб‑интерфейс обычно направляет пользователей через этот процесс, переводя их к следующему шагу рабочего процесса каждый раз, когда они завершают текущий. Однако злоумышленники не обязательно будут придерживаться этой предполагаемой последовательности. Неспособность учитывать такую возможность может привести к опасным изъянам, которые могут быть относительно простыми для эксплуатации.

Например, многие веб‑сайты, реализующие двухфакторную аутентификацию (2FA), требуют, чтобы пользователи сначала вошли на одной странице, а затем ввели код подтверждения на отдельной странице. Предположение о том, что пользователи всегда будут проходить этот процесс до конца и, как следствие, отсутствие проверки того, что они это сделали, может позволить злоумышленникам полностью обойти шаг 2FA.

Создание предположений о последовательности событий может привести к широкому спектру проблем даже в рамках одного и того же рабочего процесса или функциональности. Используя такие инструменты, как Burp Proxy и Repeater, после того как злоумышленник увидел запрос, он может воспроизводить его по своему усмотрению и использовать принудительный просмотр (forced browsing), чтобы выполнять любые взаимодействия с сервером в любом порядке. Это позволяет ему завершать различные действия, пока приложение находится в неожиданном состоянии.

Чтобы выявить такие изъяны, вы должны использовать принудительный просмотр для отправки запросов в непредусмотренной последовательности. Например, вы можете пропустить определённые шаги, получить доступ к одному шагу более одного раза, вернуться к более ранним шагам и так далее. Обратите внимание на то, как именно осуществляется доступ к разным шагам. Хотя часто вы просто отправляете GET‑ или POST‑запрос на конкретный URL, иногда можно получить доступ к шагам, отправив разные наборы параметров на один и тот же URL. Как и в случае с любыми логическими изъянами, постарайтесь определить, какие предположения сделали разработчики и где находится поверхность атаки. Затем вы можете искать способы нарушения этих предположений.

Обратите внимание, что такого рода тестирование часто вызывает исключения, потому что ожидаемые переменные имеют значения null или неинициализированы. Попадание в определённое место в частично определённом или несогласованном состоянии также, скорее всего, вызовет жалобы приложения. В этом случае обязательно обращайте пристальное внимание на любые сообщения об ошибках или отладочную информацию, с которыми вы сталкиваетесь. Они могут быть ценным источником раскрытия информации, который поможет вам уточнить атаку и понять ключевые детали поведения серверной части.

## Уязвимости, специфичные для домена

Во многих случаях вы столкнётесь с логическими изъянами, которые специфичны для бизнес‑домена или назначения сайта.

Функциональность скидок в интернет‑магазинах является классической поверхностью атаки при поиске логических изъянов. Это может быть потенциальной «золотой жилой» для злоумышленника, так как в способах применения скидок часто встречаются самые разные базовые логические ошибки.

Например, рассмотрим интернет‑магазин, который предлагает скидку 10% на заказы свыше 1000 долларов. Такая система может быть уязвима для злоупотреблений, если бизнес‑логика не проверяет, был ли заказ изменён после применения скидки. В этом случае злоумышленник может просто добавить товары в корзину, пока сумма не достигнет порога в 1000 долларов, затем удалить ненужные товары перед оформлением заказа. В результате он получит скидку на заказ, даже если он больше не удовлетворяет исходным критериям.

Вы должны уделять особое внимание любой ситуации, когда цены или другие чувствительные значения корректируются на основе критериев, определённых действиями пользователя. Постарайтесь понять, какие алгоритмы использует приложение для этих корректировок и на каком этапе они выполняются. Часто это связано с манипуляцией приложением так, чтобы оно оказалось в состоянии, когда применённые корректировки не соответствуют исходным критериям, задуманным разработчиками.

Чтобы выявить такие уязвимости, вам нужно тщательно подумать о том, какие цели может преследовать злоумышленник, и попытаться найти разные способы их достижения с использованием предоставленной функциональности. Для этого может потребоваться определённый уровень знаний в конкретной предметной области, чтобы понять, что может быть выгодным в данном контексте. Для простого примера: чтобы понять преимущества принуждения большого числа пользователей подписаться на вас, нужно понимать специфику социальных сетей.

Без этих знаний о домене вы можете отклонить опасное поведение, просто не осознавая его возможных последствий. Точно так же вам может быть трудно «соединить точки» и заметить, как две функции могут быть объединены во вредоносной комбинации. Для простоты примеры, используемые в этой теме, относятся к домену, знакомому всем пользователям, а именно к интернет‑магазину. Однако, будь вы охотником за багами, пентестером или просто разработчиком, стремящимся писать более безопасный код, вы можете в какой‑то момент столкнуться с приложениями из менее знакомых доменов. В этом случае вам следует прочитать как можно больше документации и, где это возможно, поговорить с экспертами в данной области, чтобы получить их мнение. Это может показаться большой работой, но чем более специфичен и «узок» домен, тем выше вероятность, что другие тестировщики пропустили множество ошибок.

